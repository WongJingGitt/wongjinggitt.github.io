<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Markdownè½¬æ¢å·¥å…·</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <!-- Markdown-it and plugins -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-footnote@4.0.0/dist/markdown-it-footnote.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-task-lists@2.1.1/dist/markdown-it-task-lists.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-container@4.0.0/dist/markdown-it-container.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-emoji@3.0.0/dist/markdown-it-emoji.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-deflist@3.0.0/dist/markdown-it-deflist.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-mark@4.0.0/dist/markdown-it-mark.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-sup@2.0.0/dist/markdown-it-sup.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-sub@2.0.0/dist/markdown-it-sub.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-ins@4.0.0/dist/markdown-it-ins.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/markdown-it-link-attributes@4.0.1/dist/markdown-it-link-attributes.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-abbr@2.0.0/dist/markdown-it-abbr.min.js"></script>

    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <!-- PDF/Image Export Libs -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- DOCX Export Lib -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <!-- Highlight JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.css"
        integrity="sha512-jYtlOKxyOGJQxuHAR9h4PK04vh9HzaxI0dHVXx/kqICgw82nv3UpzWkaef+Fg8g4XJEvf/W+sPOnaeYQp5SRaQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Diff Lib (jsdiff) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/7.0.0/diff.min.js"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --preview-bg: #ffffff;
            --border-color: #e1e4e8;
            --text-color: #24292e;
            --secondary-text-color: #6a737d;
            --primary-color: #0366d6;
            --primary-hover-color: #0056b3;
            --danger-color: #d73a49;
            --danger-hover-color: #cb2431;
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --modal-content-bg: #ffffff;
            --diff-enabled-color: #28a745;
            /* Bootstrap Success Green */
            --diff-disabled-color: #6c757d;
            /* Bootstrap Secondary Grey */
            --tracking-strong-color: #28a745;
            --tracking-weak-color: #dc3545;
            --warning-color: #ffc107;
            /* Bootstrap Warning Yellow/Orange */

            /* Pane Collapse Variables */
            --grid-min-pane-width: 44px; /* Width of a collapsed pane */
            --grid-columns-normal: 1fr 2fr;
            --grid-columns-editor-collapsed: var(--grid-min-pane-width) 1fr;
            --grid-columns-preview-collapsed: 1fr var(--grid-min-pane-width);
        }

        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            padding: 2rem;
            display: grid;
            /* grid-template-columns: 1fr 2fr; /* Will be set by JS */
            grid-template-columns: var(--grid-columns-normal); /* Default state */
            gap: 2rem;
            margin: 0 auto;
            height: calc(100vh - 1rem);
            box-sizing: border-box;
            transition: grid-template-columns 0.3s ease-in-out; /* Smooth transition for collapse */
        }

        .editor-box,
        .preview-box {
            background: var(--preview-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow: hidden;
            min-width: 0; /* Important for grid collapsing */
            transition: padding 0.3s ease-in-out; /* Smooth transition for padding */
        }
        
        /* Styles for collapsed panes */
        .pane-collapsed {
            padding: 0 !important;
            overflow: hidden !important;
        }

        .pane-collapsed .card-title {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 !important;
            margin: 0 !important;
            border-bottom: 1px solid var(--border-color); /* Optional: keep a line */
            flex-wrap: nowrap !important; /* Prevent button from wrapping */
        }

        .pane-collapsed .card-title > *:not(.title-collapse-btn) {
            display: none !important;
        }
        .pane-collapsed .title-collapse-btn {
            display: inline-flex !important;
            margin: 0 !important;
        }

        .pane-collapsed > *:not(.card-title) {
            display: none !important;
        }

        .title-collapse-btn {
            flex-shrink: 0; /* Prevent shrinking */
            /* margin-left: 8px; /* Default margin, adjust as needed */
        }
        .title-collapse-btn svg {
             vertical-align: middle; /* Align icon nicely */
        }


        .markdown-body {
            background: var(--preview-bg) !important;
            padding: 1.5rem !important;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow: auto;
        }

        .title-toolbar {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .preview-title-extra {
            /*margin-left: auto;*/
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #trackingStrengthIndicator,
        #changeSummaryIndicator {
            font-size: 0.8em;
            font-weight: 500;
            padding: 0.2em 0.5em;
            border-radius: 4px;
            white-space: nowrap;
            margin-right: 5px;
        }

        #trackingStrengthIndicator.strong {
            color: var(--tracking-strong-color);
            border: 1px solid var(--tracking-strong-color);
        }

        #trackingStrengthIndicator.weak {
            color: var(--tracking-weak-color);
            border: 1px solid var(--tracking-weak-color);
        }

        #changeSummaryIndicator {
            color: var(--secondary-text-color);
            font-weight: normal;
        }


        #diffStatusIndicator {
            font-size: 0.8em;
            font-weight: 500;
            padding: 0.2em 0.6em;
            border-radius: 4px;
            color: white;
            line-height: 1.5;
            white-space: nowrap;
        }

        #diffStatusIndicator.enabled {
            background-color: var(--diff-enabled-color);
        }

        #diffStatusIndicator.disabled {
            background-color: var(--diff-disabled-color);
        }

        #longTextWarning {
            color: var(--warning-color);
            font-size: 0.8em;
            margin-left: 5px;
            font-weight: 500;
        }


        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary-color);
        }

        input:focus+.slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }


        select,
        button,
        input[type="search"],
        input[type="number"],
        input[type="range"] {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: white;
            font-size: 0.9em;
            box-sizing: border-box;
        }

        input[type="range"] {
            padding: 0;
        }

        button {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        button:hover {
            border-color: #c6cbd1;
            background-color: #f6f8fa;
        }

        button:active {
            background-color: #f3f4f6;
            border-color: #c6cbd1;
            box-shadow: inset 0 1px 0 rgba(225, 228, 232, 0.2);
        }


        button.primary {
            background: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }

        button.primary:hover {
            background: var(--primary-hover-color);
            border-color: var(--primary-hover-color);
        }

        button.danger {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        button.danger:hover {
            background-color: var(--danger-hover-color);
            border-color: var(--danger-hover-color);
        }

        button.small {
            padding: 0.3rem 0.8rem;
            font-size: 0.8em;
        }

        .notice {
            color: var(--secondary-text-color);
            font-size: 0.9em;
            margin-top: 0;
        }

        .card-title {
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            flex-shrink: 0;
            box-sizing: border-box;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
        }

        .card-body {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .text-title {
            font-size: 1.25em;
            font-weight: 600;
            margin-right: 1rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-grow: 1; /* Allow title to take space */
            min-width: 0; /* Prevent overflow issues */
        }

        .active-doc-name {
            font-weight: normal;
            font-size: 0.8em;
            color: var(--secondary-text-color);
            margin-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            vertical-align: middle;
            display: inline-block;
        }

        .active-doc-status {
            font-weight: normal;
            font-size: 0.8em;
            color: var(--secondary-text-color);
            margin-left: 4px;
            white-space: nowrap;
            vertical-align: middle;
            display: inline-block;
        }

        .title-button-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            /* width: 100%; */ /* Removed for better flex behavior with collapse button */
            /* justify-content: flex-end; */ /* Let natural flow position it */
            flex-shrink: 0; /* Prevent this group from shrinking too much */
        }

        .title-button-item {
            height: 35px;
            min-width: 75px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4em;
            padding: 0.5rem 0.8rem;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .icon-button svg {
            vertical-align: middle;
            flex-shrink: 0;
        }

        .editor {
            width: 100%;
            font-family: 'Fira Code', 'Consolas', monospace;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            border: 1px solid var(--border-color);
            background: #fafafa;
        }

        #editor {
            width: 100%;
            flex-grow: 1;
            padding: 15px;
            font-size: 14px;
            line-height: 1.6;
            border: none;
            background: transparent;
            resize: none;
            tab-size: 4;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #editor:focus {
            outline: none;
        }

        .toolbar {
            padding: 8px 15px;
            background: #f6f8fa;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85em;
            color: var(--secondary-text-color);
            flex-shrink: 0;
            box-sizing: border-box;
            width: 100%;
            user-select: none;
        }

        .modal {
            display: none;
            /* ç¡®ä¿é»˜è®¤æ˜¯éšè—çš„ */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100vh;
            /* ä½¿ç”¨è§†çª—é«˜åº¦å•ä½ vh */
            overflow: hidden;
            /* ç¦æ­¢ modal æœ¬èº«æ»šåŠ¨ */
            background-color: var(--modal-overlay-bg);
            backdrop-filter: blur(3px);
        }

        /* å½“ JS å°† .modal è®¾ç½®ä¸º display: flex; æ—¶ï¼Œä»¥ä¸‹æ ·å¼ç”¨äºå±…ä¸­ modal-content */
        .modal.show-flex {
            /* åˆ›å»ºä¸€ä¸ªæ–°ç±»ç»™ JS æ¥åˆ‡æ¢ */
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .modal-content {
            background-color: var(--modal-content-bg);
            /* margin: 8% auto; */
            /* ç§»é™¤ï¼Œç”± .modal.show-flex çš„ flex å¸ƒå±€å¤„ç†å±…ä¸­ */
            margin: 20px;
            /* å¯ä»¥ç»™ä¸€ä¸ªå›ºå®šçš„å¤–è¾¹è·ï¼Œé˜²æ­¢è´´è¾¹ï¼Œå¹¶ä¸º max-height è®¡ç®—ç•™å‡ºç©ºé—´ */
            padding: 25px;
            border: 1px solid var(--border-color);
            width: 85%;
            max-width: 650px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            /* ä¿æŒ */
            animation: fadeIn 0.3s ease-out;
            display: flex;
            /* å†…éƒ¨ä»ç„¶æ˜¯flexå¸ƒå±€ */
            flex-direction: column;
            gap: 1rem;
            max-height: calc(100vh - 40px);
            /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œå‡å»ä¸Šä¸‹margin (20px + 20px) */
            overflow-y: auto;
            /* å½“å†…å®¹è¶…å‡º modal-content çš„ max-height æ—¶ï¼Œå†…å®¹åŒºæ‰æ»šåŠ¨ */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.8rem;
        }

        .modal-close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
            background: none;
            border: none;
            padding: 0 5px;
            cursor: pointer;
        }

        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: black;
            text-decoration: none;
        }

        .modal h2 {
            margin: 0;
            font-weight: 600;
            font-size: 1.3em;
        }

        .modal-toolbar {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        #searchInput,
        #historySearchInput {
            flex-grow: 1;
            min-width: 200px;
        }

        #saveNewButton,
        #saveAsVersionButton {
            display: none;
        }


        .saved-item-list,
        .history-item-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .saved-item,
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.15s ease-in-out, border-left 0.15s ease-in-out;
            gap: 10px;
        }

        .saved-item:last-child,
        .history-item:last-child {
            border-bottom: none;
        }

        .saved-item:hover,
        .history-item:hover {
            background-color: #f6f8fa;
        }

        .saved-item.highlighted-active-doc {
            background-color: #e6f7ff;
            border-left: 4px solid var(--primary-color);
            font-weight: 500;
        }

        .saved-item.highlighted-active-doc .item-name {
            color: var(--primary-hover-color);
        }


        .item-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex-grow: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 500;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-content-preview {
            font-size: 0.9em;
            color: var(--secondary-text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 350px;
            display: inline-block;
        }

        .item-timestamp {
            font-size: 0.8em;
            color: var(--secondary-text-color);
        }

        .item-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .no-items {
            text-align: center;
            color: var(--secondary-text-color);
            padding: 2rem 0;
            font-style: italic;
            border-bottom: none !important;
            display: block !important;
        }

        .no-items:hover {
            background-color: transparent !important;
        }

        .toast-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            border-radius: 6px;
            z-index: 1050;
            font-family: sans-serif;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
            pointer-events: none;
        }

        .toast-message.show {
            opacity: 1;
        }

        /* Styles for Diff Config Modal */
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .config-item label {
            font-weight: 500;
            font-size: 0.95em;
        }

        .config-item .input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-item input[type="number"] {
            width: 100px;
            /* Increased width for threshold input */
        }

        .config-item input[type="range"] {
            flex-grow: 1;
        }

        .config-item select {
            flex-grow: 1;
        }

        .config-note {
            font-size: 0.8em;
            color: var(--secondary-text-color);
            margin-top: 0.2rem;
        }

        #wordCountIndicator {
            font-size: 0.8em;
            color: var(--secondary-text-color);
            margin-left: 0.75rem;
            /* ä¸å…¶ä»–æŒ‡ç¤ºå™¨é—´éš”ä¿æŒä¸€è‡´ */
            white-space: nowrap;
        }

        /* ç¡®ä¿ .preview-title-extra (åŒ…å«å¼ºåº¦å’Œæ‘˜è¦çš„é‚£ä¸ª) ä¸å­—æ•°ç»Ÿè®¡æœ‰é—´éš” */
        .text-title>.preview-title-extra {
            margin-left: 0.75rem;
            /* å¦‚æœå­—æ•°ç»Ÿè®¡å­˜åœ¨ï¼Œè¿™ä¸ªdivå‘å³ç§»ä¸€ç‚¹ */
        }

        /* å¾®è°ƒ .text-title ä»¥å®¹çº³æ›´å¤šå…ƒç´  */
        /* .text-title {
            font-size: 1.25em;
            font-weight: 600;
            margin-right: 1rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-grow: 1;
            min-width: 0;
        } */

        .preview-box .card-title .preview-title-extra:nth-of-type(2) {
            /* æŒ‡å‘åŒ…å«å¼€å…³çš„é‚£ä¸ª preview-title-extra */
            /* margin-left: auto; /* ç¡®ä¿å¼€å…³ç»„é å³ */
        }

        /* Drag and Drop Overlay */
        #dragDropOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 123, 255, 0.1);
            /* Semi-transparent primary color */
            border: 3px dashed var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            pointer-events: none;
            /* Allow events to pass through initially */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            box-sizing: border-box;
        }

        #dragDropOverlay.visible {
            opacity: 1;
            pointer-events: auto;
            /* Block events when visible and active for drop */
        }

        #dragDropOverlay p {
            font-size: 1.8em;
            color: var(--primary-color);
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px 30px;
            border-radius: 8px;
            text-align: center;
        }

        body.drag-over #dragDropOverlay {
            /* Alternative or additional styling if needed */
            /* opacity: 1; */
        }

        /* ä¿æŒ .active-doc-name å’Œ .active-doc-status åŸæœ‰æ ·å¼ */

        /* æ–°çš„æ–‡å­—æŒ‰é’®æ ·å¼ */
        button.text-button {
            background: none;
            border: none;
            color: var(--primary-color);
            /* é»˜è®¤ä¸ºä¸»é¢˜è“è‰²ï¼Œè¡¨ç¤ºå¯ç‚¹å‡» */
            cursor: pointer;
            font-size: 0.8em;
            /* ä¸çŠ¶æ€æŒ‡ç¤ºå™¨å­—ä½“å¤§å°ä¿æŒä¸€è‡´æˆ–ç•¥å¤§ */
            font-weight: 500;
            /* ç•¥å¾®åŠ ç²— */
            padding: 0.2em 0.5em;
            /* è°ƒæ•´å†…è¾¹è·ä½¿å…¶çœ‹èµ·æ¥èˆ’é€‚ */
            margin-left: 0.5rem;
            /* ä¸å‰ä¸€ä¸ªçŠ¶æ€æŒ‡ç¤ºå™¨çš„é—´è· */
            border-radius: 4px;
            /* è½»å¾®åœ†è§’ */
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }

        button.text-button:hover {
            color: var(--primary-hover-color);
            background-color: rgba(0, 102, 214, 0.1);
            /* éå¸¸æµ…çš„èƒŒæ™¯é«˜äº® */
            text-decoration: underline;
            /* æ‚¬åœæ—¶åŠ ä¸‹åˆ’çº¿ï¼Œæ›´åƒé“¾æ¥ */
        }

        button.text-button:active {
            color: var(--primary-hover-color);
            background-color: rgba(0, 102, 214, 0.2);
            /* ç‚¹å‡»æ—¶èƒŒæ™¯ç•¥æ·± */
        }

        button.text-button:disabled {
            /* å¦‚æœæœªæ¥éœ€è¦ç¦ç”¨çŠ¶æ€ */
            color: var(--secondary-text-color);
            cursor: not-allowed;
            background-color: transparent;
            text-decoration: none;
        }

        /* Mermaid diagrams should be centered and responsive */
        .mermaid {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1em 0;
        }

        .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        /* Task lists styling (from github-markdown.css or similar) */
        .task-list-item {
            list-style-type: none;
        }

        .task-list-item input[type="checkbox"] {
            margin: 0 0.2em 0.25em -1.6em;
            vertical-align: middle;
        }

        /* è­¦å‘Šå®¹å™¨ - ç¥ç€è‰²ç³» */
        .warning-text {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: none;
            border-left: 4px solid #ff8f00;
            border-radius: 8px;
            padding: 16px 20px;
            margin: 16px 0;
            position: relative;
            box-shadow: 0 2px 8px rgba(255, 143, 0, 0.12);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .warning-text::before {
            content: "âš ";
            position: absolute;
            left: -12px;
            top: 8px;
            background: #ff8f00;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .warning-text:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(255, 143, 0, 0.18);
        }

        /* ä¿¡æ¯å®¹å™¨ - è“è‰²ç³» */
        .info-text {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: none;
            border-left: 4px solid #1976d2;
            border-radius: 8px;
            padding: 16px 20px;
            margin: 16px 0;
            position: relative;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.12);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-text::before {
            content: "i";
            position: absolute;
            left: -12px;
            top: 8px;
            background: #1976d2;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            font-style: italic;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .info-text:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.18);
        }

        /* æç¤ºå®¹å™¨ - ç»¿è‰²ç³» */
        .tip-text {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border: none;
            border-left: 4px solid #388e3c;
            border-radius: 8px;
            padding: 16px 20px;
            margin: 16px 0;
            position: relative;
            box-shadow: 0 2px 8px rgba(56, 142, 60, 0.12);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tip-text::before {
            content: "âœ“";
            position: absolute;
            left: -12px;
            top: 8px;
            background: #388e3c;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tip-text:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(56, 142, 60, 0.18);
        }

        /* å±é™©å®¹å™¨ - çº¢è‰²ç³» */
        .danger-text {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: none;
            border-left: 4px solid #d32f2f;
            border-radius: 8px;
            padding: 16px 20px;
            margin: 16px 0;
            position: relative;
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.12);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .danger-text::before {
            content: "âœ•";
            position: absolute;
            left: -12px;
            top: 8px;
            background: #d32f2f;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .danger-text:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(211, 47, 47, 0.18);
        }

        /* å†…å®¹æ®µè½æ ·å¼é‡ç½® */
        .warning-text p,
        .info-text p,
        .tip-text p,
        .danger-text p {
            margin: 0;
            line-height: 1.5;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {

            .warning-text,
            .info-text,
            .tip-text,
            .danger-text {
                padding: 12px 16px;
                margin: 12px 0;
            }

            .warning-text::before,
            .info-text::before,
            .tip-text::before,
            .danger-text::before {
                left: -10px;
                top: 6px;
                width: 18px;
                height: 18px;
                font-size: 10px;
            }
        }

        /* æš—è‰²ä¸»é¢˜é€‚é… */
        @media (prefers-color-scheme: dark) {
            .warning-text {
                background: linear-gradient(135deg, #332b1f 0%, #3d2f24 100%);
                color: #ffcc80;
            }

            .info-text {
                background: linear-gradient(135deg, #1a2332 0%, #243447 100%);
                color: #90caf9;
            }

            .tip-text {
                background: linear-gradient(135deg, #1f2b1f 0%, #2c3e2c 100%);
                color: #a5d6a7;
            }

            .danger-text {
                background: linear-gradient(135deg, #2e1a1a 0%, #3c2727 100%);
                color: #ef9a9a;
            }
        }

        .external-link {
            color: #6366f1;
            text-decoration: none;
            position: relative;
            font-weight: 550;
            transition: color 0.3s;
            padding: 0px 2px;
        }

        .external-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            transition: width 0.3s ease;
        }

        .external-link:hover {
            color: #4f46e5;
        }

        .external-link:hover::after {
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ç¼–è¾‘åŒº -->
        <div class="editor-box">
            <div class="card-title">
                <div class="text-title">
                    Markdown ç¼–è¾‘å™¨
                    <span id="activeDocInfoContainer"
                        style="display: inline-flex; align-items: center; gap: 0.5rem; margin-left: 8px;">
                        <span id="activeDocNameIndicator" class="active-doc-name"></span>
                        <span id="activeDocStatusIndicator" class="active-doc-status"></span>
                        <button id="dissociateActiveDocButton" class="small text-button"
                            onclick="manuallyDissociateActiveDocument()" title="æ¸…é™¤å½“å‰æ´»åŠ¨æ–‡æ¡£å…³è”"
                            style="display: none; padding: 0.2em 0.5em;">
                            è§£é™¤å…³è”
                        </button>
                    </span>
                </div>
                <div class="title-button-group">
                    <button onclick="importMarkdownFile()" title="å¯¼å…¥ Markdown æ–‡ä»¶" class="title-button-item icon-button">
                        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"
                            data-view-component="true" class="octicon octicon-upload">
                            <path
                                d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z M8 1.75a.75.75 0 0 1 .75.75v6.51L11.03 6.78a.75.75 0 0 1 1.06 1.06l-3.5 3.5a.75.75 0 0 1-1.06 0l-3.5-3.5a.75.75 0 1 1 1.06-1.06l2.22 2.22V2.5a.75.75 0 0 1 .75-.75Z">
                            </path>
                        </svg>
                        å¯¼å…¥
                    </button>
                    <button onclick="showLoadModal()" title="åŠ è½½å·²ä¿å­˜çš„ Markdown" class="title-button-item icon-button">
                        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"
                            data-view-component="true" class="octicon octicon-download">
                            <path
                                d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z M8 11.75a.75.75 0 0 1-.75-.75V1.5a.75.75 0 0 1 1.5 0v9.5a.75.75 0 0 1-.75-.75Zm-4.28-4.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1-1.06 1.06L8.75 4.31V9.5a.75.75 0 0 1-1.5 0V4.31L3.78 7.47a.75.75 0 0 1-1.06 0Z">
                            </path>
                        </svg>
                        åŠ è½½
                    </button>
                    <button class="primary title-button-item icon-button" onclick="showSaveModal()"
                        title="ä¿å­˜æˆ–æ›´æ–° Markdown">
                        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"
                            data-view-component="true" class="octicon octicon-file-directory-fill">
                            <path
                                d="M1.75 1A1.75 1.75 0 0 0 0 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0 0 16 13.25v-8.5A1.75 1.75 0 0 0 14.25 3H7.5a.25.25 0 0 1-.2-.09L5.95 1.36A.75.75 0 0 0 5.41 1H1.75Z">
                            </path>
                        </svg>
                        ä¿å­˜
                    </button>
                    <button onclick="showHistoryModal()" title="æŸ¥çœ‹ç¼–è¾‘å†å²" class="title-button-item icon-button">
                        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"
                            data-view-component="true" class="octicon octicon-history">
                            <path
                                d="M1.643 3.143L.427 1.927A.25.25 0 0 0 0 2.104V5.75c0 .138.112.25.25.25h3.646a.25.25 0 0 0 .177-.427L2.715 4.215a6.5 6.5 0 1 1-1.18 4.458.75.75 0 1 0-1.493.154 8.001 8.001 0 1 0 1.6-5.684zM7.75 4a.75.75 0 0 1 .75.75v4.336l3.47 2.023a.75.75 0 0 1-.74 1.298l-3.75-2.165A.75.75 0 0 1 7 9.75V4.75a.75.75 0 0 1 .75-.75z">
                            </path>
                        </svg>
                        å†å²
                    </button>
                    <button onclick="showDiffConfigModal()" title="é…ç½®æ™ºèƒ½è¯†åˆ«å…³è”" class="title-button-item icon-button">
                        <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"
                            data-view-component="true" class="octicon octicon-gear">
                            <path fill-rule="evenodd"
                                d="M8 11.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm0 1.5a5 5 0 1 0 0-10 5 5 0 0 0 0 10ZM5.44 8A2.56 2.56 0 0 1 8 5.44v.035a.75.75 0 0 1 0 1.5v-.035A.97.97 0 0 0 8 6.91a.97.97 0 0 0-.97.97.97.97 0 0 0 .97.97.97.97 0 0 0 .97-.97V8a2.56 2.56 0 0 1-2.56 2.56H5.47a.75.75 0 0 1 0-1.5h.005A2.524 2.524 0 0 1 5.44 8Zm4.12-2.56A2.56 2.56 0 0 1 10.53 8h.005a.75.75 0 0 1 0 1.5H10.5A2.56 2.56 0 0 1 8 10.56v-.035a.75.75 0 0 1 0-1.5v.035A.97.97 0 0 0 8 9.09a.97.97 0 0 0 .97-.97A.97.97 0 0 0 8 7.15.97.97 0 0 0 7.03 8.12V8A2.56 2.56 0 0 1 9.56 5.44Zm2.06.7a.75.75 0 0 1 1.06-.02l.003.004 1.5 1.5.003.003a.75.75 0 0 1 .02 1.06l-.003.004-1.5 1.5-.004.003a.75.75 0 0 1-1.06.02l.004-.003-1.5-1.5-.004-.003a.75.75 0 0 1-.02-1.06l.003-.004 1.5-1.5Zm-8.24 4.12a.75.75 0 0 1 1.06.02l-.003-.004 1.5 1.5-.003-.003a.75.75 0 0 1 .02 1.06l.003.004-1.5 1.5.004.003a.75.75 0 0 1-1.06.02l-.004-.003-1.5-1.5.004-.003a.75.75 0 0 1-.02-1.06l-.003.004 1.5-1.5Z">
                            </path>
                        </svg>
                        å…³è”è®¾ç½®
                    </button>
                    <button id="loadSampleOrRevertButton" class="title-button-item"
                        onclick="handleLoadSampleOrRevert()">åŠ è½½ç¤ºä¾‹</button>
                </div>
                <button id="toggleEditorButton" class="icon-button small title-collapse-btn" title="æ”¶èµ·ç¼–è¾‘åŒº">
                    <!-- SVG will be injected by JS -->
                </button>
            </div>
            <div class="card-body">
                <div class="editor">
                    <div class="toolbar">Markdown Editor (Tab/Shift+Tab supported)</div>
                    <textarea id="editor"
                        placeholder="Start typing markdown here... or drag & drop a .md/.txt file onto the page."></textarea>
                </div>
            </div>
        </div>

        <!-- é¢„è§ˆåŒº -->
        <div class="preview-box">
            <div class="card-title">
                <div class="text-title">
                    <div>å®æ—¶é¢„è§ˆ</div>
                    <span id="wordCountIndicator" class="word-count-indicator"></span>
                    <div class="preview-title-extra">
                        <span id="trackingStrengthIndicator" style="display: none;" title="å½“å‰ä½¿ç”¨çš„æ–¹æ¡ˆå­˜ç»­æœªä¿®æ”¹éƒ¨åˆ†çš„ç™¾åˆ†æ¯”"></span>
                        <span id="changeSummaryIndicator" style="display: none;" title="å½“å‰ç¼–è¾‘å™¨ä¸­å¯¹æ¯”ä½¿ç”¨çš„æ–¹æ¡ˆåˆå§‹çŠ¶æ€çš„å·®å¼‚"></span>
                    </div>
                </div>
                <div class="preview-title-extra">
                    <span id="diffStatusIndicator">æ™ºèƒ½è¯†åˆ«: å…³é—­</span>
                    <span id="longTextWarning" style="display: none;"></span>
                    <label class="toggle-switch" title="å¼€å¯/å…³é—­æ™ºèƒ½è¯†åˆ«å…³è”åŠŸèƒ½">
                        <input type="checkbox" id="diffTrackingToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="title-toolbar">
                    <select id="format">
                        <option value="image" selected>å›¾ç‰‡</option>
                        <option value="html">HTML</option>
                        <option value="pdf">PDF</option>
                        <option value="docx">DOCX</option>
                        <option value="markdown">Markdown (.md)</option>
                    </select>
                    <button class="primary" onclick="exportFile(event)">å¯¼å‡ºæ–‡ä»¶</button>
                    <p class="notice">æç¤ºï¼šç”Ÿæˆå›¾ç‰‡/PDFå¯èƒ½éœ€5-10ç§’</p>
                </div>
                <button id="togglePreviewButton" class="icon-button small title-collapse-btn" title="æ”¶èµ·é¢„è§ˆåŒº">
                    <!-- SVG will be injected by JS -->
                </button>
            </div>
            <div class="card-body">
                <div class="markdown-body" id="preview"></div>
            </div>
        </div>
    </div>

    <!-- Load/Save Markdown Modal -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">åŠ è½½å·²ä¿å­˜çš„ Markdown</h2>
                <button class="modal-close-btn" onclick="hideLoadModal()" title="å…³é—­">&times;</button>
            </div>
            <div class="modal-toolbar">
                <input type="search" id="searchInput" placeholder="æŒ‰åç§°æœç´¢..." oninput="filterSavedItems()">
                <button id="saveAsVersionButton" class="primary" onclick="handleSaveAsVersion()"
                    style="display: none;">å¦å­˜ä¸ºç‰ˆæœ¬...</button>
                <button id="saveNewButton" class="primary" onclick="handleSaveNew()">å¦å­˜ä¸ºæ–°...</button>
            </div>
            <ul id="savedItemList" class="saved-item-list">
                <li class="no-items">æ²¡æœ‰æ‰¾åˆ°å·²ä¿å­˜çš„æ–‡æ¡£ã€‚</li>
            </ul>
        </div>
    </div>

    <!-- Edit History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="historyModalTitle">ç¼–è¾‘å†å²è®°å½•</h2>
                <button class="modal-close-btn" onclick="hideHistoryModal()" title="å…³é—­">&times;</button>
            </div>
            <ul id="historyItemList" class="history-item-list">
                <li class="no-items">æ²¡æœ‰ç¼–è¾‘å†å²è®°å½•ã€‚</li>
            </ul>
        </div>
    </div>

    <!-- Diff Config Modal -->
    <div id="diffConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ™ºèƒ½è¯†åˆ«è®¾ç½®</h2>
                <button class="modal-close-btn" onclick="hideDiffConfigModal()" title="å…³é—­">&times;</button>
            </div>
            <div class="config-item">
                <label for="longTextThresholdInput">é•¿æ–‡æœ¬é˜ˆå€¼ (å­—ç¬¦æ•°)</label>
                <div class="input-group">
                    <input type="number" id="longTextThresholdInput" min="5000" step="1000">
                </div>
                <p class="config-note">å½“æ–‡æœ¬è¶…è¿‡æ­¤å­—ç¬¦æ•°æ—¶ï¼Œè§†ä¸ºé•¿æ–‡æœ¬ï¼Œå¯èƒ½ä¼šè§¦å‘æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‚æœ€å°5000ã€‚</p>
            </div>
            <div class="config-item">
                <label for="autoDisableDiffForLongTextToggle">é•¿æ–‡æœ¬æ—¶è‡ªåŠ¨å…³é—­æ™ºèƒ½è¯†åˆ«</label>
                <div class="input-group" style="justify-content: space-between; align-items: center;">
                    <span id="autoDisableDiffInfo" style="font-size: 0.9em; color: var(--secondary-text-color);"></span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoDisableDiffForLongTextToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="config-note">å¼€å¯åï¼Œåœ¨ç¼–è¾‘è¶…é•¿æ–‡æ¡£æ—¶å°†è‡ªåŠ¨ä¸´æ—¶å…³é—­æ™ºèƒ½è¯†åˆ«åŠŸèƒ½ï¼Œä»¥ä¿æŒåº”ç”¨æµç•…ã€‚æ¸…é™¤é•¿æ–‡æœ¬åä¼šè‡ªåŠ¨æ¢å¤åŸè®¾ç½®ã€‚</p>
            </div>
            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1rem 0;">
            <div class="config-item">
                <label for="diffAlgorithmSelect">æ¯”è¾ƒæ–¹å¼</label>
                <select id="diffAlgorithmSelect">
                    <option value="chars">å­—ç¬¦çº§ (Char by Char)</option>
                    <option value="words">è¯è¯­çº§ (Word by Word)</option>
                    <option value="lines">è¡Œçº§ (Line by Line)</option>
                </select>
                <p class="config-note">é€‰æ‹©æ¯”è¾ƒæ–‡æœ¬å·®å¼‚çš„ç²¾ç»†ç¨‹åº¦ã€‚ä¸åŒæ–¹å¼å¯¹å…³è”åˆ¤æ–­ç»“æœæœ‰å½±å“ã€‚</p>
            </div>
            <div class="config-item">
                <label for="diffDebounceTimeInput">å†…å®¹æ›´æ–°æ£€æµ‹å»¶è¿Ÿ (æ¯«ç§’)</label>
                <div class="input-group">
                    <input type="number" id="diffDebounceTimeInput" min="1000" step="100">
                </div>
                <p class="config-note">åœæ­¢è¾“å…¥åï¼Œç­‰å¾…è¿™ä¹ˆé•¿æ—¶é—´å†åˆ¤æ–­å½“å‰å†…å®¹æ˜¯å¦ä¸åŸæ–‡æ¡£å…³è”ã€‚æœ€çŸ­1ç§’ (1000æ¯«ç§’)ã€‚</p>
            </div>
            <div class="config-item">
                <label for="diffMatchThresholdInput">åŸæ–‡ç›¸ä¼¼åº¦è¦æ±‚ (%)</label>
                <div class="input-group">
                    <input type="range" id="diffMatchThresholdRange" min="50" max="100" step="1">
                    <input type="number" id="diffMatchThresholdInput" min="50" max="100" step="1" style="width: 70px;">
                    %
                </div>
                <p class="config-note">å½“å·²ä¿å­˜æ–‡æ¡£ä¸­ï¼Œè‡³å°‘æœ‰è¿™ä¸ªç™¾åˆ†æ¯”çš„å†…å®¹è¿˜å­˜åœ¨äºå½“å‰ç¼–è¾‘åŒºæ—¶ï¼Œç³»ç»Ÿä¼šè®¤ä¸ºæ‚¨ä»åœ¨ä¿®æ”¹è¯¥æ–‡æ¡£ã€‚èŒƒå›´50% - 100%ã€‚</p>
            </div>
            <button class="primary" onclick="handleSaveDiffSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- Drag and Drop Overlay -->
    <div id="dragDropOverlay" style="display: none;">
        <p>æ‹–æ”¾ Markdown æˆ–æ–‡æœ¬æ–‡ä»¶åˆ°æ­¤å¤„</p>
    </div>

    <!-- ç‹¬ç«‹ç¤ºä¾‹å†…å®¹ -->
    <script id="sampleMarkdown" type="text/template">
# æ¬¢è¿ä½¿ç”¨ Markdown ç¼–è¾‘ä¸è½¬æ¢å·¥å…· (v2.5 - powered by Markdown-it) ğŸ‘‹

æ‚¨å¥½ï¼æœ¬å·¥å…·æ—¨åœ¨ä¸ºæ‚¨æä¾›ä¸€ä¸ª**é«˜åº¦è½»é‡åŒ–ã€é«˜æ•ˆã€ä¾¿æ·**çš„ Markdown æ–‡æ¡£åœ¨çº¿ç¼–è¾‘ä¸å¤šæ ¼å¼è½¬æ¢ä½“éªŒã€‚å®ƒåŸºäºå¼ºå¤§çš„ Markdown-it è§£æå™¨ï¼Œä¸ä»…æ”¯æŒæ‰€æœ‰æ ‡å‡† Markdown è¯­æ³•ï¼Œè¿˜å†…ç½®äº†è¯¸å¤šå®ç”¨æ‰©å±•ï¼Œå¦‚ï¼š**Mermaid å›¾è¡¨ã€ä»»åŠ¡åˆ—è¡¨ã€è„šæ³¨ã€è‡ªå®šä¹‰å®¹å™¨**ç­‰ï¼ŒåŠ©æ‚¨è½»æ¾åˆ›ä½œå¯Œæ–‡æœ¬å†…å®¹ã€‚

ä¸ºäº†è®©æ‚¨å¿«é€ŸæŒæ¡å…¶æ ¸å¿ƒä»·å€¼ï¼Œè¯·é¦–å…ˆäº†è§£ä»¥ä¸‹å‡ å¤§æ ¸å¿ƒåŠŸèƒ½ã€‚è¯¦ç»†çš„ Markdown è¯­æ³•å‚è€ƒåŠ Markdown-it ç‰¹æ€§ç¤ºä¾‹è§æ–‡æœ«é™„å½•ã€‚

## ğŸš€ ä¸€ã€æ ¸å¿ƒåŠŸèƒ½æ¦‚è§ˆ

æœ¬å·¥å…·çš„æ ¸å¿ƒè®¾è®¡å›´ç»•ä»¥ä¸‹å››å¤§åŠŸèƒ½æ¨¡å—ï¼Œä¸ºæ‚¨æä¾›å…¨é¢çš„ Markdown å¤„ç†èƒ½åŠ›ï¼š

1.  **ğŸ“ å®æ—¶æ¸²æŸ“ä¸ç¼–è¾‘ï¼š**
    *   **æ¦‚å¿µï¼š** åœ¨æ‚¨ç¼–å†™ Markdown æ–‡æœ¬çš„åŒæ—¶ï¼Œå·¥å…·èƒ½å¤Ÿå³æ—¶å°†å…¶è½¬æ¢ä¸ºæ ¼å¼åŒ–åçš„é¢„è§ˆæ•ˆæœã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ç«‹åˆ»çœ‹åˆ°ä¿®æ”¹åçš„æ–‡æ¡£å¤–è§‚ï¼Œå®ç°â€œæ‰€è§å³æ‰€å¾—â€çš„ç¼–è¾‘ä½“éªŒã€‚
    *   **åŒ…å«ï¼š** å·¦ä¾§çš„ Markdown ç¼–è¾‘å™¨ï¼Œå³ä¾§çš„ HTML å®æ—¶é¢„è§ˆåŒºï¼Œä»¥åŠä¸¤è€…é—´çš„æ»šåŠ¨åŒæ­¥ã€ä»£ç é«˜äº®å’Œå­—æ•°ç»Ÿè®¡ç­‰è¾…åŠ©ç¼–è¾‘åŠŸèƒ½ã€‚

2.  **ğŸ’¾ æœ¬åœ°æŒä¹…åŒ–ä¸ç‰ˆæœ¬è¿½æº¯ï¼š**
    *   **æ¦‚å¿µï¼š** æ‚¨çš„æ‰€æœ‰å·¥ä½œï¼ˆåŒ…æ‹¬å·²ä¿å­˜çš„æ–‡æ¡£æ–¹æ¡ˆå’Œç¼–è¾‘è¿‡ç¨‹ä¸­çš„å†å²å¿«ç…§ï¼‰éƒ½ä¼šå®‰å…¨åœ°å­˜å‚¨åœ¨æ‚¨å½“å‰çš„æµè§ˆå™¨æœ¬åœ°ï¼ˆä½¿ç”¨ IndexedDB æŠ€æœ¯ï¼‰ï¼Œæ— éœ€è”ç½‘ï¼Œæ•°æ®ä¸ç¦»èº«ã€‚
    *   **åŒ…å«ï¼š**
        *   **æ–¹æ¡ˆç®¡ç†ï¼š** æ‚¨å¯ä»¥å°†å½“å‰ç¼–è¾‘çš„å†…å®¹ä¿å­˜ä¸ºä¸€ä¸ªâ€œæ–¹æ¡ˆâ€ï¼ˆå³ä¸€ä¸ªæ–‡æ¡£ï¼‰ï¼Œå¹¶è¿›è¡Œå‘½åã€‚åç»­å¯ä»¥åŠ è½½ã€æ›´æ–°æˆ–åˆ é™¤è¿™äº›å·²ä¿å­˜çš„æ–¹æ¡ˆã€‚
        *   **ç¼–è¾‘å†å²è®°å½•ï¼š** å·¥å…·ä¼šè‡ªåŠ¨è®°å½•æ‚¨çš„ç¼–è¾‘æ“ä½œï¼Œå½¢æˆå†å²å¿«ç…§ã€‚æ‚¨å¯ä»¥éšæ—¶æŸ¥çœ‹è¿™äº›å†å²è®°å½•ï¼Œå¹¶å°†æ–‡æ¡£æ¢å¤åˆ°ä»»ä¸€å†å²çŠ¶æ€ã€‚

3.  **ğŸ”„ å¯¼å…¥ä¸å¯¼å‡ºï¼š**
    *   **æ¦‚å¿µï¼š** æ–¹ä¾¿æ‚¨å°†å¤–éƒ¨ Markdown å†…å®¹å¯¼å…¥åˆ°ç¼–è¾‘å™¨ä¸­è¿›è¡Œå¤„ç†ï¼ŒåŒæ—¶ä¹Ÿèƒ½å°†ç¼–è¾‘å®Œæˆçš„å†…å®¹å¯¼å‡ºä¸ºå¤šç§å¸¸ç”¨æ–‡ä»¶æ ¼å¼ï¼Œæ»¡è¶³ä¸åŒçš„åˆ†äº«å’Œä½¿ç”¨éœ€æ±‚ã€‚
    *   **åŒ…å«ï¼š**
        *   **å¯¼å…¥ï¼š** æ”¯æŒä»æœ¬åœ°è®¡ç®—æœºå¯¼å…¥ `.md` æˆ– `.txt` æ–‡ä»¶ï¼ˆé€šè¿‡æŒ‰é’®æˆ–æ‹–æ‹½ï¼‰ã€‚
        *   **å¯¼å‡ºï¼š** æ”¯æŒå°†å½“å‰æ–‡æ¡£å¯¼å‡ºä¸ºå›¾ç‰‡ (.png)ã€HTML (.html)ã€PDF (.pdf)ã€Word æ–‡æ¡£ (.docx) ä»¥åŠåŸå§‹ Markdown (.md) æ ¼å¼ã€‚

4.  **ğŸ’¡ æ™ºèƒ½è¯†åˆ«å…³è”ï¼š**
    *   **æ¦‚å¿µï¼š** å½“æ‚¨åŠ è½½ä¸€ä¸ªå·²ä¿å­˜çš„æ–‡æ¡£æˆ–å¯¼å…¥ä¸€ä¸ªæ–‡ä»¶å¹¶è¿›è¡Œä¿®æ”¹æ—¶ï¼Œæ­¤åŠŸèƒ½ä¼šå°è¯•åˆ¤æ–­æ‚¨å½“å‰çš„ç¼–è¾‘å†…å®¹æ˜¯å¦ä»ç„¶æ˜¯åŸºäºåŸæ–‡æ¡£/æ–‡ä»¶çš„â€œå»¶ç»­â€æˆ–â€œä¿®æ”¹ç‰ˆâ€ï¼Œå³ä½¿å†…å®¹å‘ç”Ÿäº†è¾ƒå¤§å˜åŒ–ã€‚
    *   **åŒ…å«ï¼š**
        *   **å…³è”çŠ¶æ€åé¦ˆï¼š** é€šè¿‡é¢„è§ˆåŒºçš„æŒ‡ç¤ºå™¨ï¼ˆç™¾åˆ†æ¯”ã€å˜æ›´æ‘˜è¦ï¼‰å±•ç¤ºå½“å‰å†…å®¹ä¸â€œæ´»åŠ¨æ–‡æ¡£â€åŸå§‹ç‰ˆæœ¬çš„å…³è”ç¨‹åº¦ã€‚
        *   **è¾…åŠ©å†³ç­–ï¼š** æ ¹æ®å…³è”åˆ¤æ–­ï¼Œå·¥å…·ä¼šåœ¨ä¿å­˜ã€å¯¼å‡ºç­‰æ“ä½œæ—¶æä¾›æ›´æ™ºèƒ½çš„é»˜è®¤è¡Œä¸ºï¼ˆå¦‚ä½¿ç”¨åŸæ–‡æ¡£åå¯¼å‡ºã€åœ¨ä¿å­˜åˆ—è¡¨é«˜äº®åŸæ–‡æ¡£ã€å»ºè®®â€œå¦å­˜ä¸ºç‰ˆæœ¬â€ç­‰ï¼‰ã€‚
        *   **å¯é…ç½®æ€§ï¼š** æ‚¨å¯ä»¥è°ƒæ•´æ­¤åŠŸèƒ½çš„æ•æ„Ÿåº¦ã€æ¯”è¾ƒæ–¹å¼ï¼Œç”šè‡³åœ¨å¤„ç†è¶…é•¿æ–‡æœ¬æ—¶å¯ç”¨è‡ªåŠ¨ä¸´æ—¶å…³é—­ç­–ç•¥ï¼Œä»¥å¹³è¡¡åŠŸèƒ½æ€§ä¸æ€§èƒ½ã€‚

## ğŸ“– äºŒã€ä½¿ç”¨æ‰‹å†Œï¼šå¿«é€Ÿä¸Šæ‰‹æŒ‡å—

äº†è§£äº†æ ¸å¿ƒåŠŸèƒ½åï¼Œä»¥ä¸‹æ˜¯å¦‚ä½•æ“ä½œæœ¬å·¥å…·çš„å…·ä½“æ­¥éª¤ï¼š

### (ä¸€) å¼€å§‹å†™ä½œä¸é¢„è§ˆ âœï¸

1.  **ç¼–è¾‘å™¨ (å·¦ä¾§)ï¼š**
    *   ç›´æ¥åœ¨æ­¤åŒºåŸŸè¾“å…¥æ‚¨çš„ Markdown å†…å®¹ã€‚
    *   ä½¿ç”¨ `Tab` é”®è¿›è¡Œåˆ—è¡¨æˆ–ä»£ç å—çš„ç¼©è¿›ï¼Œ`Shift + Tab` å–æ¶ˆç¼©è¿›ã€‚
    *   æ‚¨å¯ä»¥å°† `.md` æˆ– `.txt` æ–‡ä»¶ç›´æ¥æ‹–æ‹½åˆ°é¡µé¢ä¸Šï¼Œå…¶å†…å®¹ä¼šè‡ªåŠ¨è½½å…¥ç¼–è¾‘å™¨ã€‚
2.  **é¢„è§ˆåŒº (å³ä¾§)ï¼š**
    *   æ‚¨è¾“å…¥çš„å†…å®¹ä¼šå®æ—¶æ˜¾ç¤ºä¸ºæ ¼å¼åŒ–åçš„æ•ˆæœã€‚
    *   ä»£ç å—ä¼šè‡ªåŠ¨é«˜äº®æ˜¾ç¤ºã€‚
    *   æ»šåŠ¨ç¼–è¾‘åŒºæˆ–é¢„è§ˆåŒºï¼Œå¦ä¸€ä¾§ä¼šåŒæ­¥æ»šåŠ¨ã€‚
    *   â€œå®æ—¶é¢„è§ˆâ€æ–‡å­—æ—è¾¹ä¼šæ˜¾ç¤ºå½“å‰çš„**å­—ç¬¦æ•°**å’Œ**è¯è¯­æ•°**ã€‚
3.  **åŠ è½½ç¤ºä¾‹å†…å®¹ï¼š**
    *   è‹¥æƒ³å¿«é€Ÿä½“éªŒæˆ–æŸ¥çœ‹ç¤ºä¾‹ï¼Œç‚¹å‡»ç¼–è¾‘å™¨é¡¶éƒ¨æŒ‰é’®æ çš„ã€åŠ è½½ç¤ºä¾‹ã€‘æŒ‰é’®ã€‚æœ¬æ–‡æ¡£ï¼ˆæ“ä½œæŒ‡å—ï¼‰å°†è¢«åŠ è½½ã€‚

### (äºŒ) æ–‡æ¡£çš„ä¿å­˜ã€åŠ è½½ä¸ç®¡ç† ğŸ“‚

*   **ä¿å­˜å½“å‰æ–‡æ¡£ï¼š**
    1.  ç‚¹å‡»ç¼–è¾‘å™¨é¡¶éƒ¨ã€ğŸ’¾ä¿å­˜ã€‘æŒ‰é’®ã€‚
    2.  åœ¨å¼¹çª—ä¸­ï¼š
        *   è‹¥è¦åˆ›å»ºå…¨æ–°æ–‡æ¡£ï¼Œç‚¹å‡»ã€å¦å­˜ä¸ºæ–°...ã€‘ï¼Œè¾“å…¥åç§°åä¿å­˜ã€‚
        *   è‹¥æ™ºèƒ½è¯†åˆ«åˆ°å½“å‰å†…å®¹æ˜¯å¯¹æŸä¸ªå·²åŠ è½½æˆ–å¯¼å…¥æ–‡æ¡£çš„æ˜¾è‘—ä¿®æ”¹ï¼ˆä¾‹å¦‚ï¼Œå†…å®¹ç›¸ä¼¼åº¦åœ¨85%-97%ä¹‹é—´ï¼‰ï¼Œå¯èƒ½ä¼šå‡ºç°ã€å¦å­˜ä¸º "[åŸå] v.æ—¶é—´æˆ³"ã€‘æŒ‰é’®ï¼Œæ–¹ä¾¿åˆ›å»ºç‰ˆæœ¬ã€‚
        *   è‹¥è¦è¦†ç›–æ›´æ–°å·²å­˜åœ¨çš„æ–‡æ¡£ï¼ˆé€šå¸¸ä¼šè¢«é«˜äº®æ˜¾ç¤ºï¼‰ï¼Œç‚¹å‡»å…¶å³ä¾§çš„ã€æ›´æ–°ã€‘æŒ‰é’®ï¼Œå¯ä¿®æ”¹åç§°åç¡®è®¤ã€‚
    3.  æˆåŠŸä¿å­˜åï¼Œè¯¥æ–‡æ¡£å°†æˆä¸ºâ€œæ´»åŠ¨æ–‡æ¡£â€ï¼Œç¼–è¾‘å™¨æ ‡é¢˜æ ä¼šæ˜¾ç¤ºå…¶åç§°å’ŒçŠ¶æ€ã€‚

*   **åŠ è½½å·²å­˜æ–‡æ¡£ï¼š**
    1.  ç‚¹å‡»ç¼–è¾‘å™¨é¡¶éƒ¨ã€ğŸ“‚ åŠ è½½ã€‘æŒ‰é’®ã€‚
    2.  åœ¨å¼¹çª—ä¸­ï¼Œä½¿ç”¨æœç´¢æ¡†æˆ–æµè§ˆåˆ—è¡¨æ‰¾åˆ°ç›®æ ‡æ–‡æ¡£ã€‚
    3.  ç‚¹å‡»æ–‡æ¡£æ¡ç›®å³ä¾§çš„ã€åŠ è½½ã€‘æŒ‰é’®ï¼Œå…¶å†…å®¹å°†è½½å…¥ç¼–è¾‘å™¨ï¼Œå¹¶æˆä¸ºæ–°çš„â€œæ´»åŠ¨æ–‡æ¡£â€ã€‚

*   **åˆ é™¤å·²å­˜æ–‡æ¡£ï¼š**
    *   åœ¨ã€åŠ è½½ã€‘å¼¹çª—çš„æ–‡æ¡£åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»æ–‡æ¡£æ¡ç›®å³ä¾§çš„ã€åˆ é™¤ã€‘æŒ‰é’®ã€‚

*   **æŸ¥çœ‹ä¸æ¢å¤ç¼–è¾‘å†å²ï¼š**
    1.  ç‚¹å‡»ç¼–è¾‘å™¨é¡¶éƒ¨ã€ğŸ“œ å†å²ã€‘æŒ‰é’®ã€‚
    2.  å¼¹çª—ä¸­ä¼šåˆ—å‡ºæ‚¨è¿‘æœŸçš„ç¼–è¾‘å¿«ç…§ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰ã€‚
    3.  ç‚¹å‡»æŸæ¡è®°å½•æ—çš„ã€æ¢å¤ã€‘æŒ‰é’®ï¼Œå¯å°†ç¼–è¾‘å™¨å†…å®¹æ¢å¤è‡³è¯¥çŠ¶æ€ã€‚ï¼ˆæ³¨æ„ï¼šè¿™ä¼šæ¸…é™¤å½“å‰æ´»åŠ¨æ–‡æ¡£çŠ¶æ€ï¼‰
    4.  ç‚¹å‡»ã€åˆ é™¤ã€‘å¯ç§»é™¤è¯¥æ¡å†å²è®°å½•ã€‚

*   **ä»æœ¬åœ°æ–‡ä»¶å¯¼å…¥ï¼ˆé€šè¿‡æŒ‰é’®ï¼‰ï¼š**
    1.  ç‚¹å‡»ç¼–è¾‘å™¨é¡¶éƒ¨ã€ğŸ“¥ å¯¼å…¥ã€‘æŒ‰é’®ã€‚
    2.  åœ¨å¼¹å‡ºçš„æ–‡ä»¶é€‰æ‹©æ¡†ä¸­ï¼Œé€‰æ‹©æ‚¨ç”µè„‘ä¸Šçš„ `.md` æˆ– `.txt` æ–‡ä»¶ã€‚
    3.  æ–‡ä»¶å†…å®¹å°†è¢«è½½å…¥ç¼–è¾‘å™¨ã€‚ï¼ˆæ³¨æ„ï¼šè¿™ä¼šè¦†ç›–å½“å‰ç¼–è¾‘å†…å®¹å¹¶è®¾ç½®å¯¼å…¥æ–‡ä»¶ä¸ºæ–°çš„æ´»åŠ¨æ–‡æ¡£èµ·ç‚¹ï¼‰

### (ä¸‰) ä½¿ç”¨æ™ºèƒ½è¯†åˆ«å…³è”åŠŸèƒ½ ğŸ’¡

æ­¤åŠŸèƒ½é»˜è®¤å¼€å¯ï¼ˆå¯é€šè¿‡é¢„è§ˆåŒºå³ä¸Šè§’å¼€å…³æ§åˆ¶ï¼‰ã€‚

1.  **é…ç½®æ™ºèƒ½è¯†åˆ«ï¼š**
    *   ç‚¹å‡»ç¼–è¾‘å™¨é¡¶éƒ¨ã€âš™ï¸ å…³è”è®¾ç½®ã€‘æŒ‰é’®ã€‚
    *   åœ¨å¼¹çª—ä¸­ï¼Œæ‚¨å¯ä»¥è‡ªå®šä¹‰ï¼š
        *   **é•¿æ–‡æœ¬é˜ˆå€¼ï¼š** å®šä¹‰å¤šé•¿çš„æ–‡æœ¬ä¼šè§¦å‘é•¿æ–‡æœ¬ä¼˜åŒ–ç­–ç•¥ã€‚
        *   **é•¿æ–‡æœ¬è‡ªåŠ¨å…³é—­ï¼š** (é»˜è®¤å¼€å¯) æ–‡æœ¬è¶…é•¿æ—¶ä¸´æ—¶å…³é—­æ™ºèƒ½è¯†åˆ«ä»¥ä¿æµç•…ã€‚
        *   **æ¯”è¾ƒæ–¹å¼ï¼š** å†…å®¹å¯¹æ¯”çš„ç®—æ³•ï¼ˆå­—ç¬¦ã€è¯ã€è¡Œï¼‰ã€‚
        *   **æ£€æµ‹å»¶è¿Ÿï¼š** åœæ­¢è¾“å…¥å¤šä¹…åå¼€å§‹åˆ†æã€‚
        *   **åŸæ–‡ç›¸ä¼¼åº¦è¦æ±‚(%)ï¼š** åˆ¤å®šå…³è”çš„é˜ˆå€¼ã€‚

2.  **æŸ¥çœ‹å…³è”çŠ¶æ€ï¼š**
    *   å½“æ‚¨åŠ è½½äº†ä¸€ä¸ªå·²ä¿å­˜çš„æ–‡æ¡£ã€æˆ–å¯¼å…¥äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶å¼€å§‹ç¼–è¾‘åï¼ˆä¸”æ™ºèƒ½è¯†åˆ«å¼€å¯ï¼‰ï¼š
        *   é¢„è§ˆåŒºæ ‡é¢˜æ çš„â€œå®æ—¶é¢„è§ˆâ€å³ä¾§ä¼šæ˜¾ç¤ºï¼š
            *   **å…³è”å¼ºåº¦ (%)ï¼š** å½“å‰å†…å®¹ä¸æ´»åŠ¨æ–‡æ¡£åŸå§‹ç‰ˆæœ¬çš„ç›¸ä¼¼åº¦ã€‚ç»¿è‰²è¡¨ç¤ºé«˜åº¦å…³è”ï¼Œçº¢è‰²åˆ™è¾ƒä½ã€‚
            *   **å˜æ›´æ‘˜è¦ï¼š** å¦‚â€œ+Xå­— -Yå­—â€ï¼Œæ˜¾ç¤ºå†…å®¹å˜åŒ–é‡ã€‚
        *   ç¼–è¾‘å™¨æ ‡é¢˜æ â€œæ´»åŠ¨æ–‡æ¡£â€çŠ¶æ€ä¼šç›¸åº”æ›´æ–°ä¸ºâ€œ(è¯†åˆ«ä¸ºä¿®æ”¹ç‰ˆ)â€æˆ–â€œ(å…³è”åº¦ä½)â€ç­‰ã€‚

3.  **â€œæ¢å¤åŸå§‹å†…å®¹â€æŒ‰é’®ï¼š**
    *   è‹¥æ´»åŠ¨æ–‡æ¡£ï¼ˆæ— è®ºæ˜¯åŠ è½½çš„è¿˜æ˜¯å¯¼å…¥çš„ï¼‰å†…å®¹è¢«ä¿®æ”¹ï¼Œç¼–è¾‘å™¨é¡¶éƒ¨çš„ã€åŠ è½½ç¤ºä¾‹ã€‘æŒ‰é’®ä¼šå˜ä¸ºã€ğŸ”„ æ¢å¤åŸå§‹å†…å®¹ã€‘ã€‚
    *   ç‚¹å‡»æ­¤æŒ‰é’®å¹¶ç¡®è®¤åï¼Œç¼–è¾‘å™¨å†…å®¹å°†å›é€€åˆ°æ´»åŠ¨æ–‡æ¡£åˆšåŠ è½½/å¯¼å…¥æ—¶çš„çŠ¶æ€ã€‚

4.  **åŠŸèƒ½å½±å“ï¼š**
    *   **å¯¼å‡ºæ–‡ä»¶åï¼š** è‹¥è¯†åˆ«ä¸ºå…³è”ï¼Œé»˜è®¤å¯¼å‡ºæ–‡ä»¶åä¼šåŸºäºæ´»åŠ¨æ–‡æ¡£åï¼ˆæ— è®ºæ˜¯åŠ è½½çš„è¿˜æ˜¯å¯¼å…¥çš„ï¼‰ã€‚
    *   **ä¿å­˜åˆ—è¡¨é«˜äº®ï¼š** ä¿å­˜æ—¶ï¼Œå…³è”çš„æ´»åŠ¨æ–‡æ¡£ä¼šåœ¨åˆ—è¡¨çªå‡ºæ˜¾ç¤ºã€‚

### (å››) æ–‡ä»¶å¯¼å‡º ğŸš€

1.  **é€‰æ‹©æ ¼å¼ï¼š**
    *   åœ¨é¢„è§ˆåŒºé¡¶éƒ¨çš„ä¸‹æ‹‰èœå•ä¸­ï¼Œé€‰æ‹©æ‚¨å¸Œæœ›å¯¼å‡ºçš„æ–‡ä»¶ç±»å‹ï¼šå›¾ç‰‡ (.png), HTML (.html), PDF (.pdf), Word (.docx), æˆ– Markdown (.md)ã€‚
2.  **æ‰§è¡Œå¯¼å‡ºï¼š**
    *   ç‚¹å‡»ã€å¯¼å‡ºæ–‡ä»¶ã€‘æŒ‰é’®ã€‚æ–‡ä»¶å°†å¼€å§‹ç”Ÿæˆå¹¶ä¸‹è½½ã€‚
    *   *æç¤ºï¼šå›¾ç‰‡/PDF ç”Ÿæˆå¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚PDFä¸ºå›¾ç‰‡æ ¼å¼ï¼Œæ–‡å­—ä¸å¯é€‰ã€‚*

## ğŸŒ± ä¸‰ã€æœªæ¥è®¡åˆ’

æˆ‘ä»¬è®¡åˆ’æŒç»­ä¼˜åŒ–å¹¶æ·»åŠ æ–°åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š

- **æ•°æ®ç®¡ç†å¼ºåŒ–ï¼š** æ ‡ç­¾/æ–‡ä»¶å¤¹ç³»ç»Ÿï¼Œå®Œæ•´æ•°æ®å¤‡ä»½ä¸æ¢å¤ã€‚
- **ç¼–è¾‘å¢å¼ºï¼š** ç¼–è¾‘å™¨å†…æŸ¥æ‰¾æ›¿æ¢ç­‰ã€‚
- ...ä»¥åŠæ›´å¤šæƒŠå–œï¼

---

## ğŸ“š é™„å½•ï¼šMarkdown è¯­æ³•å‚è€ƒ

æœ¬ç¼–è¾‘å™¨é‡‡ç”¨ Markdown-it è§£æå™¨ï¼Œæ”¯æŒ GFM (GitHub Flavored Markdown) æ ‡å‡†è¯­æ³•åŠå¤šç§å®ç”¨æ‰©å±•ã€‚

### (ä¸€) åŸºç¡€è¯­æ³•

#### 1. æ ‡é¢˜ (Headers)
```markdown
# è¿™æ˜¯ä¸€çº§æ ‡é¢˜ (H1)
## è¿™æ˜¯äºŒçº§æ ‡é¢˜ (H2)
### è¿™æ˜¯ä¸‰çº§æ ‡é¢˜ (H3)
#### è¿™æ˜¯å››çº§æ ‡é¢˜ (H4)
##### è¿™æ˜¯äº”çº§æ ‡é¢˜ (H5)
###### è¿™æ˜¯å…­çº§æ ‡é¢˜ (H6)
```

#### 2. å¼ºè°ƒ (Emphasis)
```markdown
*è¿™æ˜¯æ–œä½“æ–‡æœ¬*
_è¿™ä¹Ÿæ˜¯æ–œä½“æ–‡æœ¬_

**è¿™æ˜¯ç²—ä½“æ–‡æœ¬**
__è¿™ä¹Ÿæ˜¯ç²—ä½“æ–‡æœ¬__

***è¿™æ˜¯ç²—æ–œä½“æ–‡æœ¬***
___è¿™ä¹Ÿæ˜¯ç²—æ–œä½“æ–‡æœ¬___
```

#### 3. åˆ—è¡¨ (Lists)
##### æ— åºåˆ—è¡¨
```markdown
- é¡¹ç›®ä¸€
- é¡¹ç›®äºŒ
    - å­é¡¹ç›® A
    - å­é¡¹ç›® B
* é¡¹ç›®ä¸‰
+ é¡¹ç›®å››
```
##### æœ‰åºåˆ—è¡¨
```markdown
1. ç¬¬ä¸€é¡¹
2. ç¬¬äºŒé¡¹
    1. å­é¡¹ 1
    2. å­é¡¹ 2
3. ç¬¬ä¸‰é¡¹
```

#### 4. é“¾æ¥ (Links)
```markdown
è¿™æ˜¯[è¡Œå†…é“¾æ¥](https://example.com)ï¼Œè€Œè¿™æ˜¯[å¼•ç”¨é“¾æ¥][1]

[1]: https://example.com "å¯é€‰æ ‡é¢˜"
```

#### 5. å›¾ç‰‡ (Images)
```markdown
![æ›¿ä»£æ–‡æœ¬](image.jpg "å›¾ç‰‡æ ‡é¢˜")
```

#### 6. ä»£ç  (Code)
##### è¡Œå†…ä»£ç 
`è¿™æ˜¯è¡Œå†…ä»£ç å—`

##### ä»£ç å— (Fenced Code Blocks)
```javascript
function greet(name) {
    console.log("Hello, " + name + "!");
}
greet("World");
```

#### 7. å¼•ç”¨ (Blockquotes)
```markdown
> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨å—ã€‚
>
> > åµŒå¥—å¼•ç”¨ã€‚
```

#### 8. åˆ†éš”çº¿ (Horizontal Rules)
```markdown
---
***
___
```

#### 9. è¡¨æ ¼ (Tables) - GFM
```markdown
| è¡¨å¤´1 | è¡¨å¤´2 | è¡¨å¤´3 |
| :---- | :---: | ----: |
| å·¦å¯¹é½ | å±…ä¸­  | å³å¯¹é½ |
| å†…å®¹A | å†…å®¹B | å†…å®¹C |
```
**æ•ˆæœ:**

| è¡¨å¤´1 | è¡¨å¤´2 | è¡¨å¤´3 |
| :---- | :---: | ----: |
| å·¦å¯¹é½ | å±…ä¸­  | å³å¯¹é½ |
| å†…å®¹A | å†…å®¹B | å†…å®¹C |

---

### (äºŒ) Markdown-it æ‰©å±•ç‰¹æ€§ç¤ºä¾‹ âœ¨

æ­¤ç‰ˆæœ¬å·²åˆ‡æ¢åˆ° Markdown-it è§£æå™¨ï¼Œå¹¶æ”¯æŒæ›´å¤šé«˜çº§è¯­æ³•ï¼š

#### 1. Mermaid å›¾è¡¨ ğŸ§œâ€â™€ï¸

æ‚¨ç°åœ¨å¯ä»¥ç›´æ¥åœ¨ Markdown ä¸­åµŒå…¥ Mermaid å›¾è¡¨ï¼š

```mermaid
graph TD
    A[Christmas] -->|Get money| B(Go shopping)
    B --> C{Let me think}
    C -->|One| D[Laptop]
    C -->|Two| E[iPhone]
    C -->|Three| F[fa:fa-car Car]
```

#### 2. ä»»åŠ¡åˆ—è¡¨ (Task Lists) âœ…

- [x] å­¦ä¹  Markdown-it
- [ ] æŒæ¡ Mermaid é›†æˆ
- [ ] å‘å¸ƒæ–°ç‰ˆæœ¬

#### 3. è„šæ³¨ (Footnotes) [^1]

è¿™æ˜¯ä¸€ä¸ªå¸¦æœ‰è„šæ³¨çš„å¥å­ã€‚è„šæ³¨å†…å®¹åœ¨æ–‡æ¡£æœ«å°¾å®šä¹‰ã€‚

[^1]: è¿™æ˜¯è„šæ³¨çš„å…·ä½“å†…å®¹ã€‚

#### 4. è‡ªå®šä¹‰å®¹å™¨ (Custom Containers) ğŸ“¦

::: tip-text
è¿™æ˜¯ä¸€ä¸ªæç¤ºç±»å‹çš„è‡ªå®šä¹‰å®¹å™¨ã€‚
:::

::: warning-text
è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šç±»å‹çš„è‡ªå®šä¹‰å®¹å™¨ã€‚æ³¨æ„å®‰å…¨ï¼
:::

::: info-text
è¿™æ˜¯ä¸€ä¸ªä¿¡æ¯ç±»å‹çš„è‡ªå®šä¹‰å®¹å™¨ã€‚
:::

::: danger-text
è¿™æ˜¯ä¸€ä¸ªå±é™©ç±»å‹çš„è‡ªå®šä¹‰å®¹å™¨ã€‚
:::

#### 5. å®šä¹‰åˆ—è¡¨ (Definition Lists) ğŸ“š

è‹¹æœ
:   ä¸€ç§å¸¸è§çš„æ°´æœï¼Œå¯Œå«ç»´ç”Ÿç´ ã€‚

é¦™è•‰
:   å¦ä¸€ç§å—æ¬¢è¿çš„æ°´æœï¼Œèƒ½é‡æ¥æºã€‚

#### 6. å…¶ä»–å®ç”¨è¯­æ³•

ä¸Šæ ‡
: `H^2^O` æ¸²æŸ“ä¸º H^2^O

ä¸‹æ ‡
: `CO~2~` æ¸²æŸ“ä¸º CO~2~

åˆ é™¤çº¿
: `~~åˆ é™¤~~` æ¸²æŸ“ä¸º ~~åˆ é™¤~~

ä¸‹åˆ’çº¿ (Insert)
: `++ä¸‹åˆ’çº¿++` æ¸²æŸ“ä¸º ++ä¸‹åˆ’çº¿++

é«˜äº®æ–‡æœ¬ (Mark)
: `==é«˜äº®æ–‡æœ¬==` æ¸²æŸ“ä¸º ==é«˜äº®æ–‡æœ¬==

è¡¨æƒ…ç¬¦å· (Emoji)
: `:smile:` æ¸²æŸ“ä¸º :smile:
: `:tada:` æ¸²æŸ“ä¸º :tada:
: `:rocket:` æ¸²æŸ“ä¸º :rocket:

ç¼©å†™æ ‡ç­¾
: å†™æ³•ï¼š
    ```markdown
    The HTML specification
    is maintained by the W3C.

    *[HTML]: Hyper Text Markup Language
    *[W3C]:  World Wide Web Consortium
    ```
: æ¸²æŸ“:
    The HTML specification
    is maintained by the W3C.

    *[HTML]: Hyper Text Markup Language
    *[W3C]:  World Wide Web Consortium
---

> æ„Ÿè°¢æ‚¨çš„è€å¿ƒé˜…è¯»ï¼å¸Œæœ›æœ¬æŒ‡å—èƒ½åŠ©æ‚¨è½»æ¾é©¾é©­è¿™æ¬¾ Markdown å·¥å…·ã€‚ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰
    </script>

    <script>
        // --- Global Variables & Constants ---
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const sampleContent = document.getElementById('sampleMarkdown').textContent.trim();
        const loadModal = document.getElementById('loadModal');
        const savedItemList = document.getElementById('savedItemList');
        const searchInput = document.getElementById('searchInput');
        const modalTitle = document.getElementById('modalTitle');
        const saveNewButton = document.getElementById('saveNewButton');
        const saveAsVersionButton = document.getElementById('saveAsVersionButton');
        const historyModal = document.getElementById('historyModal');
        const historyItemList = document.getElementById('historyItemList');
        const loadSampleOrRevertButton = document.getElementById('loadSampleOrRevertButton');
        const wordCountIndicator = document.getElementById('wordCountIndicator');
        const dragDropOverlay = document.getElementById('dragDropOverlay');

        let md; // Markdown-it instance

        const DB_NAME = 'markdownDB';
        const SAVED_STORE_NAME = 'savedMarkdown';
        const HISTORY_STORE_NAME = 'editHistory';
        const HISTORY_LIMIT = 50;
        let db;
        let historySaveTimeout;
        let lastSavedHistoryContent = null;
        let isSyncing = false;

        // --- Intelligent Association & Performance Variables ---
        let LONG_TEXT_THRESHOLD = 20000; // Default, will be loaded from localStorage
        let wasDiffTrackingEnabledBeforeLongText = null;
        let isDiffTrackingEnabled = false;
        let diffAlgorithmType = 'chars';
        let diffDebounceTime = 1500;
        let diffMatchThreshold = 0.85;
        const SIGNIFICANT_MODIFICATION_THRESHOLD = 0.97; // MODIFIED from 0.95
        let jsdiffInstance = null;
        let diffDebounceTimeout = null;
        let currentDiffAnalysisResult = { isRetained: false, rate: 0, diffs: [] };
        let activeSavedDocument = { id: null, name: null, originalContent: null, isImported: false };


        const diffConfigModal = document.getElementById('diffConfigModal');
        const diffAlgorithmSelect = document.getElementById('diffAlgorithmSelect');
        const diffDebounceTimeInput = document.getElementById('diffDebounceTimeInput');
        const diffMatchThresholdRange = document.getElementById('diffMatchThresholdRange');
        const diffMatchThresholdInput = document.getElementById('diffMatchThresholdInput');
        const diffTrackingToggle = document.getElementById('diffTrackingToggle');
        const diffStatusIndicator = document.getElementById('diffStatusIndicator');
        const trackingStrengthIndicator = document.getElementById('trackingStrengthIndicator');
        const changeSummaryIndicator = document.getElementById('changeSummaryIndicator');
        const longTextThresholdInput = document.getElementById('longTextThresholdInput');
        const autoDisableDiffForLongTextToggle = document.getElementById('autoDisableDiffForLongTextToggle');
        const longTextWarningSpan = document.getElementById('longTextWarning');
        const autoDisableDiffInfoSpan = document.getElementById('autoDisableDiffInfo');
        const activeDocInfoContainer = document.getElementById('activeDocInfoContainer');
        const activeDocNameEl = document.getElementById('activeDocNameIndicator');
        const activeDocStatusEl = document.getElementById('activeDocStatusIndicator');
        const dissociateActiveDocButton = document.getElementById('dissociateActiveDocButton');
        let previewUpdateDebounceTimeout;
        const DEBOUNCE_DELAY_PREVIEW = 250;

        // --- Pane Collapse Variables ---
        let editorPaneCollapsed = false;
        let previewPaneCollapsed = false;
        const editorPane = document.querySelector('.editor-box');
        const previewPane = document.querySelector('.preview-box');
        const pageContainer = document.querySelector('.container'); // Renamed to avoid conflict
        const toggleEditorBtn = document.getElementById('toggleEditorButton');
        const togglePreviewBtn = document.getElementById('togglePreviewButton');

        const ICONS = {
            chevronLeft: '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M9.78 12.78a.75.75 0 0 1-1.06 0L4.47 8.53a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 1.06L6.06 8l3.72 3.72a.75.75 0 0 1 0 1.06Z"></path></svg>',
            chevronRight: '<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16"><path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"></path></svg>'
        };

        function updateWordCount() {
            if (!editor || !wordCountIndicator) return;
            const text = editor.value.trim();
            let charCount = text.length;
            let wordCount = 0;
            if (text) {
                const words = text.split(/\s+/).filter(s => s.length > 0);
                wordCount = words.length;
            }
            wordCountIndicator.textContent = `å­—ç¬¦: ${charCount.toLocaleString()} | è¯è¯­: ${wordCount.toLocaleString()}`;
            wordCountIndicator.title = `å­—ç¬¦æ•°: ${charCount.toLocaleString()}, è¯è¯­æ•° (æŒ‰ç©ºæ ¼/æ¢è¡Œåˆ†éš”): ${wordCount.toLocaleString()}`;
            wordCountIndicator.style.display = charCount > 0 ? 'inline' : 'none';
        }

        function showToast(message, duration = 3000) {
            document.querySelectorAll('.toast-message').forEach(t => t.remove());
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'toast-message';
            document.body.appendChild(toast);
            requestAnimationFrame(() => {
                requestAnimationFrame(() => { toast.classList.add('show'); });
            });
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Tab' && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey) {
                e.preventDefault(); handleIndentation('indent');
            } else if (e.key === 'Tab' && e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey) {
                e.preventDefault(); handleIndentation('unindent');
            }
        });
        function handleIndentation(action) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const value = editor.value;
            const tab = '    ';
            if (start === end) {
                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                if (action === 'indent') {
                    editor.setRangeText(tab, start, start, 'end');
                } else {
                    const line = value.substring(lineStart, start);
                    if (line.startsWith(tab)) { editor.setRangeText('', lineStart, lineStart + tab.length, 'end'); }
                    else if (line.startsWith('\t')) { editor.setRangeText('', lineStart, lineStart + 1, 'end'); }
                    else {
                        const leadingSpaces = line.match(/^[ ]{1,4}/);
                        if (leadingSpaces) { editor.setRangeText('', lineStart, lineStart + leadingSpaces[0].length, 'end'); }
                    }
                }
            } else {
                const selectionLineStart = value.lastIndexOf('\n', start - 1) + 1;
                const textToModify = value.substring(selectionLineStart, end);
                let modifiedText = '';
                let lineShiftFirst = 0;
                const lines = textToModify.split('\n');
                lines.forEach((line, index) => {
                    let currentLineShift = 0;
                    if (action === 'indent') {
                        modifiedText += tab + line; currentLineShift = tab.length;
                    } else {
                        if (line.startsWith(tab)) { modifiedText += line.substring(tab.length); currentLineShift = -tab.length; }
                        else if (line.startsWith('\t')) { modifiedText += line.substring(1); currentLineShift = -1; }
                        else {
                            const leadingSpaces = line.match(/^[ ]{1,4}/);
                            if (leadingSpaces) { modifiedText += line.substring(leadingSpaces[0].length); currentLineShift = -leadingSpaces[0].length; }
                            else { modifiedText += line; }
                        }
                    }
                    if (index < lines.length - 1) { modifiedText += '\n'; }
                    if (index === 0) {
                        if (start > selectionLineStart) { lineShiftFirst = currentLineShift > 0 ? tab.length : Math.max(currentLineShift, -(start - selectionLineStart)); }
                        else { lineShiftFirst = currentLineShift; }
                    }
                });
                editor.setRangeText(modifiedText, selectionLineStart, end, 'select');
                const finalStart = Math.max(selectionLineStart, start + lineShiftFirst);
                const lengthDifference = modifiedText.length - textToModify.length;
                const finalEnd = end + lengthDifference;
                editor.setSelectionRange(finalStart, finalEnd);
            }
            requestPreviewUpdate();
            triggerHistorySave();
            checkAndManageDiffForLongText();
            handleContentChangeForAssociation();
            updateLoadSampleOrRevertButtonState();
        }

        // --- Markdown-it Initialization ---
        function initializeMarkdownIt() {

            function markdownItMermaid(md) {
                const defaultRenderer = md.renderer.rules.fence;

                md.renderer.rules.fence = function (tokens, idx, options, env, renderer) {
                    const token = tokens[idx];
                    const info = token.info ? token.info.trim() : '';

                    if (info === 'mermaid') {
                        const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                        return `<div class="mermaid" id="${id}">${token.content}</div>`;
                    }

                    return defaultRenderer(tokens, idx, options, env, renderer);
                };
            }

            md = window.markdownit({
                html: true,        // Enable HTML tags in source
                xhtmlOut: false,   // Use '/' in tags like <br />
                breaks: true,      // Convert '\n' in paragraphs into <br>
                langPrefix: 'language-', // CSS language prefix for fenced blocks
                linkify: true,     // Autoconvert URL-like text to links
                typographer: true, // Enable some language-neutral replacement + quotes beautification
                highlight: function (str, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(str, { language: lang, ignoreIllegals: true }).value;
                        } catch (__) { }
                    }
                    try { // Fallback to auto-highlighting if specific lang fails or not provided
                        return hljs.highlightAuto(str).value;
                    } catch (__) { }
                    return md.utils.escapeHtml(str); // use 'md.utils.escapeHtml(str)' if you want to escape and show as plain text
                }
            });

            // Use plugins
            if (window.markdownitFootnote) md.use(window.markdownitFootnote);
            if (window.markdownitTaskLists) md.use(window.markdownitTaskLists, { enabled: true, label: true, labelAfter: true });
            if (window.markdownitContainer) {
                md.use(window.markdownitContainer, 'warning-text');
                md.use(window.markdownitContainer, 'tip-text');
                md.use(window.markdownitContainer, 'info-text');
                md.use(window.markdownitContainer, 'danger-text');
                // You can add more container types here
            }
            if (window.markdownitEmoji) md.use(window.markdownitEmoji);
            if (window.markdownitDeflist) md.use(window.markdownitDeflist);
            if (window.markdownitMermaid) md.use(window.markdownitMermaid);
            if (window.markdownitMark) md.use(window.markdownitMark);
            if (window.markdownitSub) md.use(window.markdownitSub);
            if (window.markdownitSup) md.use(window.markdownitSup);
            if (window.markdownitIns) md.use(window.markdownitIns);
            if (window.markdownitLinkAttributes) md.use(window.markdownitLinkAttributes, { attrs: { target: '_blank', rel: 'noopener', class: 'external-link' } });
            if (window.markdownitAbbr) md.use(window.markdownitAbbr);

            md.use(markdownItMermaid);
            // Initialize Mermaid.js
            if (window.mermaid) {
                mermaid.initialize({
                    startOnLoad: true,
                    theme: 'default',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true
                    }
                });
            }
        }


        function handleLoadSampleOrRevert() {
            if (activeSavedDocument.id && editor.value !== activeSavedDocument.originalContent) {
                if (confirm(`ç¡®å®šè¦æ”¾å¼ƒå½“å‰å¯¹æ–‡æ¡£ "${activeSavedDocument.name}" çš„æ›´æ”¹ï¼Œå¹¶æ¢å¤åˆ°åŸå§‹å†…å®¹å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                    editor.value = activeSavedDocument.originalContent;
                    requestPreviewUpdate();
                    triggerHistorySave();
                    checkAndManageDiffForLongText();
                    handleContentChangeForAssociation();
                    updateLoadSampleOrRevertButtonState();
                    updateWordCount();
                    showToast(`å·²æ¢å¤æ–‡æ¡£ "${activeSavedDocument.name}" çš„åŸå§‹å†…å®¹ã€‚`);
                }
            } else {
                editor.value = sampleContent;
                requestPreviewUpdate();
                showToast("ç¤ºä¾‹å†…å®¹å·²åŠ è½½");
                lastSavedHistoryContent = null;
                clearActiveSavedDocumentState(true);
                checkAndManageDiffForLongText();
                updateLoadSampleOrRevertButtonState();
                updateWordCount();
            }
        }

        function updateLoadSampleOrRevertButtonState() {
            if (activeSavedDocument.id && activeSavedDocument.originalContent !== null && editor.value !== activeSavedDocument.originalContent) {
                loadSampleOrRevertButton.innerHTML = `<svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-sync"><path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-2.203-2.202a.75.75 0 0 1 1.06-1.06l3.5 3.5a.75.75 0 0 1 0 1.06l-3.5 3.5a.75.75 0 1 1-1.06-1.06l2.203-2.202A7.001 7.001 0 0 1 1.07 8.725a.75.75 0 0 1 .635-.72Z M11 2.5a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V3.569l-2.203 2.202a.75.75 0 0 1-1.06-1.06l3.5-3.5a.75.75 0 0 1 1.06 0l3.5 3.5a.75.75 0 0 1-1.06 1.06L11.93 3.57V2.5Z"></path></svg> æ¢å¤åŸå§‹å†…å®¹`;
                loadSampleOrRevertButton.title = `æ”¾å¼ƒå½“å‰ä¿®æ”¹ï¼Œæ¢å¤åˆ°æ–‡æ¡£ "${escapeHtml(activeSavedDocument.name)}" çš„åŸå§‹å†…å®¹`;
            } else {
                loadSampleOrRevertButton.textContent = 'åŠ è½½ç¤ºä¾‹';
                loadSampleOrRevertButton.title = 'åŠ è½½å†…ç½®çš„ç¤ºä¾‹Markdownå†…å®¹';
            }
        }


        function requestPreviewUpdate() {
            clearTimeout(previewUpdateDebounceTimeout);
            previewUpdateDebounceTimeout = setTimeout(() => {
                updatePreview();
            }, DEBOUNCE_DELAY_PREVIEW);
        }

        async function updatePreview() {
            try {
                if (!md) initializeMarkdownIt(); // Ensure md is initialized
                preview.innerHTML = md.render(editor.value);

                // Render Mermaid diagrams
                if (window.mermaid) {
                    await mermaid.run({
                        nodes: preview.querySelectorAll('.mermaid')
                    }).catch(err => {
                        console.error("Mermaid rendering error in preview:", err);
                    });
                }
            } catch (e) {
                console.error("Markdown Parsing/Rendering Error:", e);
                preview.innerHTML = `<p style="color: red;">Error parsing Markdown. Check console for details.</p>`;
            }
        }

        function importMarkdownFile() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.md,.txt,text/markdown,text/plain';
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e_reader) => {
                        handleImportedFileContent(e_reader.target.result, file.name, 'button');
                    };
                    reader.onerror = (e_reader) => { console.error("File reading error:", e_reader.target.error); showToast("æ–‡ä»¶è¯»å–å¤±è´¥ã€‚"); };
                    reader.readAsText(file);
                }
            };
            fileInput.click();
        }

        function handleImportedFileContent(content, filename, sourceType = 'drag-drop') {
            editor.value = content?.replace(/\r/g, '');
            clearActiveSavedDocumentState(true);
            activeSavedDocument.id = `imported-${Date.now()}`;
            activeSavedDocument.name = filename.replace(/\.[^/.]+$/, "");
            activeSavedDocument.originalContent = content?.replace(/\r/g, '');
            activeSavedDocument.isImported = true;
            currentDiffAnalysisResult = { isRetained: true, rate: 1.0, diffs: [] };
            requestPreviewUpdate();
            triggerHistorySave();
            showToast(`æ–‡ä»¶ "${filename}" å·²é€šè¿‡${sourceType === 'button' ? 'æŒ‰é’®' : 'æ‹–æ”¾'}å¯¼å…¥ï¼`);
            checkAndManageDiffForLongText();
            updateActiveDocIndicators();
            updateLoadSampleOrRevertButtonState();
            updateWordCount();
        }


        async function exportFile(event) {
            const format = document.getElementById('format').value;
            const markdownInput = editor.value;
            const exportButton = event.target;
            const originalButtonText = exportButton.textContent;

            exportButton.disabled = true;
            exportButton.textContent = 'å¯¼å‡ºä¸­...';

            if (!md) initializeMarkdownIt(); // Ensure md is initialized

            const baseFilename = generateBaseFilename();
            let filenameWithExt = `${baseFilename}.txt`;

            if (format === 'markdown') {
                try {
                    filenameWithExt = `${baseFilename}.md`;
                    triggerDownload(
                        URL.createObjectURL(new Blob([markdownInput], { type: 'text/markdown;charset=UTF-8' })),
                        filenameWithExt
                    );
                    showToast('Markdown æ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');
                } catch (error) {
                    showToast(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
                    console.error("Export Error (Markdown):", error);
                } finally {
                    exportButton.disabled = false;
                    exportButton.textContent = originalButtonText;
                }
                return;
            }

            // For other formats, render Markdown to HTML first
            let renderedHtml;
            try {
                renderedHtml = md.render(markdownInput);
            } catch (e) {
                showToast(`Markdown è§£æé”™è¯¯ï¼Œæ— æ³•å¯¼å‡º: ${e.message}`);
                console.error("Markdown rendering error for export:", e);
                exportButton.disabled = false;
                exportButton.textContent = originalButtonText;
                return;
            }

            const previewElement = document.getElementById('preview'); // Used for styling reference
            const captureContainer = document.createElement('div');
            captureContainer.className = 'markdown-body'; // Apply github-markdown styles
            Object.assign(captureContainer.style, {
                position: 'absolute', left: '-9999px', top: '0px',
                padding: '2rem', background: getComputedStyle(document.documentElement).getPropertyValue('--preview-bg').trim() || '#ffffff',
                width: previewElement.scrollWidth + 'px', // Use current preview width as a base
                minWidth: '600px', height: 'auto', overflow: 'visible',
                boxSizing: 'content-box'
            });
            captureContainer.innerHTML = renderedHtml; // Put rendered HTML into the capture container
            document.body.appendChild(captureContainer);

            // Wait for DOM updates and render Mermaid diagrams within the captureContainer
            await new Promise(resolve => requestAnimationFrame(resolve));
            if (window.mermaid) {
                try {
                    await mermaid.run({ nodes: captureContainer.querySelectorAll('.mermaid') });
                } catch (mermaidError) {
                    console.error("Mermaid rendering error in export container:", mermaidError);
                    showToast("è­¦å‘Šï¼šMermaid å›¾è¡¨åœ¨å¯¼å‡ºæ—¶æ¸²æŸ“å¤±è´¥ï¼Œå¯èƒ½ä¸æ˜¾ç¤ºã€‚", 4000);
                }
            }
            await new Promise(resolve => setTimeout(resolve, 200)); // Extra delay for rendering complex SVGs

            try {
                switch (format) {
                    case 'image':
                    case 'pdf':
                        const scale = window.devicePixelRatio || 2;
                        const canvas = await html2canvas(captureContainer, {
                            scale: scale, useCORS: true, logging: false, scrollX: 0, scrollY: 0,
                            windowWidth: captureContainer.scrollWidth,
                            windowHeight: captureContainer.scrollHeight,
                            backgroundColor: getComputedStyle(captureContainer).backgroundColor
                        });
                        if (format === 'image') {
                            filenameWithExt = `${baseFilename}.png`;
                            triggerDownload(canvas.toDataURL('image/png'), filenameWithExt);
                            showToast('å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼');
                        } else {
                            filenameWithExt = `${baseFilename}.pdf`;
                            const { jsPDF } = window.jspdf;
                            const imgData = canvas.toDataURL('image/png');
                            const imgProps = { width: canvas.width / scale, height: canvas.height / scale };
                            const pdf = new jsPDF({
                                orientation: imgProps.width > imgProps.height ? 'l' : 'p',
                                unit: 'px',
                                format: [imgProps.width, imgProps.height]
                            });
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            const ratio = Math.min(pdfWidth / imgProps.width, pdfHeight / imgProps.height);
                            pdf.addImage(imgData, 'PNG', (pdfWidth - imgProps.width * ratio) / 2, 0, imgProps.width * ratio, imgProps.height * ratio);
                            pdf.save(filenameWithExt);
                            showToast('PDFå¯¼å‡ºæˆåŠŸï¼(ä½œä¸ºå•é¡µå›¾ç‰‡)');
                        }
                        break;
                    case 'html':
                        filenameWithExt = `${baseFilename}.html`;
                        // captureContainer.innerHTML already has the rendered HTML including SVGs
                        const fullHTML = createFullHtml(captureContainer.innerHTML);
                        triggerDownload(
                            URL.createObjectURL(new Blob([fullHTML], { type: 'text/html;charset=UTF-8' })),
                            filenameWithExt
                        );
                        showToast('HTMLå¯¼å‡ºæˆåŠŸï¼');
                        break;
                    case 'docx':
                        filenameWithExt = `${baseFilename}.docx`;
                        const docxHtmlString = createFullHtml(captureContainer.innerHTML);
                        if (typeof htmlDocx === 'undefined') throw new Error("html-docx-js library not loaded.");
                        const fileBlob = htmlDocx.asBlob(docxHtmlString);
                        triggerDownload(URL.createObjectURL(fileBlob), filenameWithExt);
                        showToast('DOCXå¯¼å‡ºæˆåŠŸï¼');
                        break;
                }
            } catch (error) {
                showToast(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
                console.error("Export Error:", error);
            } finally {
                if (document.body.contains(captureContainer)) document.body.removeChild(captureContainer);
                exportButton.disabled = false;
                exportButton.textContent = originalButtonText;
            }
        }

        function createFullHtml(bodyContent) {
            return `
                <!DOCTYPE html>
                <html lang="zh-CN" xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="UTF-8">
                    <title>Exported Markdown</title>
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.css">
                    <style>
                        body { font-family: Calibri, sans-serif; font-size: 11pt; padding: 1in; margin: 0; }
                        .markdown-body { }
                        pre { background-color: #f6f8fa; border: 1px solid #e1e4e8; padding: 1em; overflow: auto; font-family: Consolas, monospace; }
                        code { font-family: Consolas, monospace; font-size: 90%; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #dfe2e5; padding: 6px 13px; }
                        blockquote { border-left: .25em solid #dfe2e5; color: #6a737d; padding: 0 1em; margin-left: 0; }
                        :root { --preview-bg: #ffffff; --border-color: #e1e4e8; }
                        /* Mermaid diagram centering for export */
                        .mermaid { display: flex; justify-content: center; margin: 1em 0; }
                        .mermaid svg { max-width: 100%; height: auto; }
                        /* Task lists styling */
                        .task-list-item { list-style-type: none; }
                        .task-list-item input[type="checkbox"] { margin: 0 0.2em 0.25em -1.6em; vertical-align: middle; }
                        /* Styles for custom containers */
                        .markdown-body .custom-container { padding: .01em 16px; margin-top: 16px!important; margin-bottom: 16px!important; border-radius: 4px; }
                        .markdown-body .custom-container.warning { background-color: #fffbe6; border-left: 4px solid #ffc107; }
                        .markdown-body .custom-container.tip { background-color: #e7f3fe; border-left: 4px solid #2196F3; }
                        .markdown-body .custom-container.info { background-color: #ddf4ff; border-left: 4px solid #00bcd4; }
                        .markdown-body .custom-container-title { font-weight: bold; margin-bottom: 0.5em; }
                    </style>
                     <!--[if gte mso 9]>
                     <xml>
                         <w:WordDocument>
                         <w:View>Print</w:View>
                         <w:Zoom>100</w:Zoom>
                         <w:DoNotOptimizeForBrowser/>
                         </w:WordDocument>
                     </xml>
                     <![endif]-->
                </head>
                <body>
                    <div class="markdown-body">
                        ${bodyContent}
                    </div>
                 </body>
                </html>
            `;
        }
        function triggerDownload(dataURL, filename) {
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            if (dataURL.startsWith('blob:')) {
                setTimeout(() => URL.revokeObjectURL(dataURL), 100);
            }
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                if (db) return resolve(db);
                const request = indexedDB.open(DB_NAME, 2);
                request.onerror = (event) => reject("Database error: " + event.target.error);
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("Database opened successfully (v2)");
                    getLastHistoryEntryContent().then(content => {
                        lastSavedHistoryContent = content;
                    }).catch(err => console.error("Error getting initial last history entry:", err));
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    console.log("Database upgrade needed");
                    const tempDb = event.target.result;
                    if (!tempDb.objectStoreNames.contains(SAVED_STORE_NAME)) {
                        const savedStore = tempDb.createObjectStore(SAVED_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        savedStore.createIndex('name', 'name', { unique: false });
                        savedStore.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log("Object store 'savedMarkdown' created");
                    }
                    if (!tempDb.objectStoreNames.contains(HISTORY_STORE_NAME)) {
                        const historyStore = tempDb.createObjectStore(HISTORY_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        historyStore.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log("Object store 'editHistory' created");
                    }
                };
            });
        }
        async function saveMarkdown(name, content) {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([SAVED_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(SAVED_STORE_NAME);
                const timestamp = new Date();
                const request = store.add({ name, content, timestamp });
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject("Error saving: " + event.target.error);
                    transaction.onerror = (event) => reject("Save transaction error: " + event.target.error);
                });
            } catch (error) { showToast(`ä¿å­˜å¤±è´¥: ${error}`); throw error; }
        }
        async function updateMarkdown(id, name, content) {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([SAVED_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(SAVED_STORE_NAME);
                const timestamp = new Date();
                const request = store.put({ id, name, content, timestamp });
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(id);
                    request.onerror = (event) => reject("Error updating: " + event.target.error);
                    transaction.onerror = (event) => reject("Update transaction error: " + event.target.error);
                });
            } catch (error) { showToast(`æ›´æ–°å¤±è´¥: ${error}`); throw error; }
        }
        async function loadAllMarkdown() {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([SAVED_STORE_NAME], 'readonly');
                const store = transaction.objectStore(SAVED_STORE_NAME);
                const index = store.index('timestamp');
                const request = index.getAll();
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const sortedResults = request.result.sort((a, b) => b.timestamp - a.timestamp);
                        resolve(sortedResults);
                    };
                    request.onerror = (event) => reject("Error loading all: " + event.target.error);
                    transaction.onerror = (event) => reject("Load all transaction error: " + event.target.error);
                });
            } catch (error) { showToast(`åŠ è½½åˆ—è¡¨å¤±è´¥: ${error}`); return []; }
        }
        async function loadMarkdownById(id) {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([SAVED_STORE_NAME], 'readonly');
                const store = transaction.objectStore(SAVED_STORE_NAME);
                const request = store.get(id);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject("Error loading by ID: " + event.target.error);
                    transaction.onerror = (event) => reject("Load ID transaction error: " + event.target.error);
                });
            } catch (error) { showToast(`åŠ è½½æ–‡æ¡£å¤±è´¥: ${error}`); return null; }
        }
        async function deleteMarkdownById(id) {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([SAVED_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(SAVED_STORE_NAME);
                const request = store.delete(id);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(true);
                    request.onerror = (event) => reject("Error deleting: " + event.target.error);
                    transaction.onerror = (event) => reject("Delete transaction error: " + event.target.error);
                });
            } catch (error) { showToast(`åˆ é™¤å¤±è´¥: ${error}`); return false; }
        }

        function scheduleHistorySave() { clearTimeout(historySaveTimeout); historySaveTimeout = setTimeout(saveCurrentStateToHistory, 2000); }
        function triggerHistorySave() { clearTimeout(historySaveTimeout); setTimeout(saveCurrentStateToHistory, 0); }
        async function saveCurrentStateToHistory() {
            const content = editor.value;
            if (content === sampleContent && !activeSavedDocument.id) return;
            if (!content.trim() || content === lastSavedHistoryContent) return;
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([HISTORY_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(HISTORY_STORE_NAME);
                const request = store.add({ content, timestamp: new Date() });
                request.onsuccess = (e) => {
                    lastSavedHistoryContent = content;
                    pruneHistory();
                };
                request.onerror = (event) => console.error("Error saving history entry:", event.target.error);
                transaction.onerror = (event) => console.error("History save transaction error:", event.target.error);
            } catch (error) { console.error("Failed to initiate history save:", error); }
        }
        async function pruneHistory() {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([HISTORY_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(HISTORY_STORE_NAME);
                const countRequest = store.count();
                countRequest.onsuccess = () => {
                    const count = countRequest.result;
                    if (count > HISTORY_LIMIT) {
                        const itemsToDelete = count - HISTORY_LIMIT;
                        let deletedCount = 0;
                        const index = store.index('timestamp');
                        const cursorRequest = index.openCursor(null, 'next');
                        cursorRequest.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor && deletedCount < itemsToDelete) {
                                cursor.delete();
                                deletedCount++;
                                cursor.continue();
                            } else {
                                if (deletedCount > 0) console.log(`Pruning complete. Deleted ${deletedCount} entries.`);
                            }
                        };
                        cursorRequest.onerror = (event) => console.error("Error opening cursor for pruning:", event.target.error);
                    }
                };
                countRequest.onerror = (event) => console.error("Error counting history items:", event.target.error);
                transaction.onerror = (event) => console.error("History prune transaction error: " + event.target.error);
            } catch (error) { console.error("Failed to initiate history pruning:", error); }
        }
        async function loadAllHistory() {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([HISTORY_STORE_NAME], 'readonly');
                const store = transaction.objectStore(HISTORY_STORE_NAME);
                const index = store.index('timestamp');
                const request = index.getAll();
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        const sortedResults = request.result.sort((a, b) => b.timestamp - a.timestamp);
                        resolve(sortedResults);
                    };
                    request.onerror = (event) => reject("Error loading history: " + event.target.error);
                    transaction.onerror = (event) => reject("Load history transaction error: " + event.target.error);
                });
            } catch (error) { showToast(`åŠ è½½å†å²å¤±è´¥: ${error}`); return []; }
        }
        async function loadHistoryById(id) {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([HISTORY_STORE_NAME], 'readonly');
                const store = transaction.objectStore(HISTORY_STORE_NAME);
                const request = store.get(id);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject("Error loading history ID: " + event.target.error);
                    transaction.onerror = (event) => reject("Load history ID transaction error: " + event.target.error);
                });
            } catch (error) { showToast(`åŠ è½½å†å²æ¡ç›®å¤±è´¥: ${error}`); return null; }
        }
        async function deleteHistoryById(id) {
            try {
                const dbInstance = await initDB();
                const transaction = dbInstance.transaction([HISTORY_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(HISTORY_STORE_NAME);
                const request = store.delete(id);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(true);
                    request.onerror = (event) => reject("Error deleting history: " + event.target.error);
                    transaction.onerror = (event) => reject("Delete history transaction error: " + event.target.error);
                });
            } catch (error) { showToast(`åˆ é™¤å†å²å¤±è´¥: ${error}`); return false; }
        }
        async function getLastHistoryEntryContent() {
            return new Promise(async (resolve, reject) => {
                try {
                    const dbInstance = await initDB();
                    const transaction = dbInstance.transaction([HISTORY_STORE_NAME], 'readonly');
                    const store = transaction.objectStore(HISTORY_STORE_NAME);
                    const index = store.index('timestamp');
                    const cursorRequest = index.openCursor(null, 'prev');
                    cursorRequest.onsuccess = (event) => {
                        const cursor = event.target.result;
                        resolve(cursor ? cursor.value.content : null);
                    };
                    cursorRequest.onerror = (event) => reject("Error getting last history entry: " + event.target.error);
                    transaction.onerror = (event) => reject("Last history transaction error: " + event.target.error);
                } catch (error) { reject("Failed to initiate get last history: " + error); }
            });
        }


        function loadDiffSettings() {
            isDiffTrackingEnabled = localStorage.getItem('diffTrackingEnabled') === 'true';
            diffAlgorithmType = localStorage.getItem('diffAlgorithmType') || 'chars';
            diffDebounceTime = parseInt(localStorage.getItem('diffDebounceTime'), 10) || 1500;
            if (diffDebounceTime < 1000) diffDebounceTime = 1000;
            diffMatchThreshold = parseFloat(localStorage.getItem('diffMatchThreshold')) || 0.85;
            if (diffMatchThreshold < 0.5) diffMatchThreshold = 0.5;
            if (diffMatchThreshold > 1.0) diffMatchThreshold = 1.0;
            LONG_TEXT_THRESHOLD = parseInt(localStorage.getItem('longTextThreshold'), 10) || 20000;
            if (LONG_TEXT_THRESHOLD < 5000) LONG_TEXT_THRESHOLD = 5000;
            const autoDisable = localStorage.getItem('autoDisableDiffForLongText');
            autoDisableDiffForLongTextToggle.checked = autoDisable === null ? true : (autoDisable === 'true');
            diffTrackingToggle.checked = isDiffTrackingEnabled;
            diffAlgorithmSelect.value = diffAlgorithmType;
            diffDebounceTimeInput.value = diffDebounceTime;
            diffMatchThresholdInput.value = Math.round(diffMatchThreshold * 100);
            diffMatchThresholdRange.value = Math.round(diffMatchThreshold * 100);
            longTextThresholdInput.value = LONG_TEXT_THRESHOLD;
            updateAutoDisableDiffInfoSpan();
            updateDiffStatusIndicator();
        }

        function saveDiffSettings() {
            localStorage.setItem('diffTrackingEnabled', isDiffTrackingEnabled);
            localStorage.setItem('diffAlgorithmType', diffAlgorithmType);
            localStorage.setItem('diffDebounceTime', diffDebounceTime);
            localStorage.setItem('diffMatchThreshold', diffMatchThreshold);
            localStorage.setItem('longTextThreshold', LONG_TEXT_THRESHOLD);
            localStorage.setItem('autoDisableDiffForLongText', autoDisableDiffForLongTextToggle.checked);
        }

        function updateAutoDisableDiffInfoSpan() {
            if (autoDisableDiffInfoSpan) autoDisableDiffInfoSpan.textContent = `è¶…è¿‡ ${LONG_TEXT_THRESHOLD.toLocaleString()} å­—ç¬¦æ—¶ä¸´æ—¶å…³é—­`;
        }

        function checkAndManageDiffForLongText() {
            const currentContentLength = editor.value.length;
            const autoDisableSetting = autoDisableDiffForLongTextToggle.checked;
            if (currentContentLength > LONG_TEXT_THRESHOLD) {
                if (isDiffTrackingEnabled) {
                    if (wasDiffTrackingEnabledBeforeLongText === null) {
                        wasDiffTrackingEnabledBeforeLongText = true;
                    }
                    if (autoDisableSetting) {
                        isDiffTrackingEnabled = false;
                        diffTrackingToggle.checked = false;
                        updateDiffStatusIndicator();
                        showToast("æ£€æµ‹åˆ°é•¿æ–‡æœ¬ï¼Œä¸ºä¿æŒæµç•…ï¼Œæ™ºèƒ½è¯†åˆ«å·²ä¸´æ—¶å…³é—­ã€‚", 4000);
                    } else { updateLongTextWarningUI(true); }
                }
            } else {
                if (wasDiffTrackingEnabledBeforeLongText === true) {
                    isDiffTrackingEnabled = true;
                    diffTrackingToggle.checked = true;
                    updateDiffStatusIndicator();
                    showToast("æ–‡æœ¬é•¿åº¦æ¢å¤ï¼Œæ™ºèƒ½è¯†åˆ«å·²è‡ªåŠ¨é‡æ–°å¼€å¯ã€‚", 3000);
                    wasDiffTrackingEnabledBeforeLongText = null;
                }
                updateLongTextWarningUI(false);
            }
        }

        function updateLongTextWarningUI(show) {
            if (longTextWarningSpan) {
                longTextWarningSpan.textContent = show ? '(é•¿æ–‡æœ¬è­¦å‘Š)' : '';
                longTextWarningSpan.style.display = show ? 'inline' : 'none';
            }
        }


        function updateDiffStatusIndicator() {
            if (!jsdiffInstance) {
                diffStatusIndicator.textContent = 'æ™ºèƒ½è¯†åˆ«: ä¸å¯ç”¨';
                diffStatusIndicator.classList.remove('enabled');
                diffStatusIndicator.classList.add('disabled');
                diffTrackingToggle.checked = false;
                diffTrackingToggle.disabled = true;
                trackingStrengthIndicator.style.display = 'none';
                changeSummaryIndicator.style.display = 'none';
                updateLongTextWarningUI(false);
                return;
            }
            if (isDiffTrackingEnabled) {
                diffStatusIndicator.textContent = 'æ™ºèƒ½è¯†åˆ«: å¼€å¯';
                diffStatusIndicator.classList.remove('disabled');
                diffStatusIndicator.classList.add('enabled');
            } else {
                diffStatusIndicator.textContent = 'æ™ºèƒ½è¯†åˆ«: å…³é—­';
                diffStatusIndicator.classList.remove('enabled');
                diffStatusIndicator.classList.add('disabled');
                currentDiffAnalysisResult.isRetained = false;
                updateLongTextWarningUI(false);
            }
            updateActiveDocIndicators();
        }

        diffTrackingToggle.addEventListener('change', (event) => {
            isDiffTrackingEnabled = event.target.checked;
            if (isDiffTrackingEnabled) { wasDiffTrackingEnabledBeforeLongText = null; }
            saveDiffSettings();
            updateDiffStatusIndicator();
            showToast(`æ™ºèƒ½è¯†åˆ«å…³è”åŠŸèƒ½å·²${isDiffTrackingEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
            checkAndManageDiffForLongText();
            if (isDiffTrackingEnabled && activeSavedDocument.id) {
                handleContentChangeForAssociation();
            } else {
                currentDiffAnalysisResult.isRetained = false;
                updateActiveDocIndicators();
            }
        });

        function showDiffConfigModal() {
            longTextThresholdInput.value = LONG_TEXT_THRESHOLD;
            autoDisableDiffForLongTextToggle.checked = localStorage.getItem('autoDisableDiffForLongText') === null ? true : (localStorage.getItem('autoDisableDiffForLongText') === 'true');
            updateAutoDisableDiffInfoSpan();
            diffAlgorithmSelect.value = diffAlgorithmType;
            diffAlgorithmSelect.disabled = !jsdiffInstance;
            diffDebounceTimeInput.value = diffDebounceTime;
            const thresholdPercent = Math.round(diffMatchThreshold * 100);
            diffMatchThresholdInput.value = thresholdPercent;
            diffMatchThresholdRange.value = thresholdPercent;
            diffConfigModal.style.display = 'flex';
            diffConfigModal.classList.add('show-flex');
        }
        function hideDiffConfigModal() {
            diffConfigModal.style.display = 'none';
            diffConfigModal.classList.remove('show-flex');
        }

        diffMatchThresholdRange.addEventListener('input', (e) => {
            diffMatchThresholdInput.value = e.target.value;
        });
        diffMatchThresholdInput.addEventListener('input', (e) => {
            let val = parseInt(e.target.value, 10);
            if (val < 50) val = 50;
            if (val > 100) val = 100;
            e.target.value = val;
            diffMatchThresholdRange.value = val;
        });


        function handleSaveDiffSettings() {
            const newLongTextThreshold = parseInt(longTextThresholdInput.value, 10);
            if (newLongTextThreshold >= 5000) { LONG_TEXT_THRESHOLD = newLongTextThreshold; }
            else { showToast("é•¿æ–‡æœ¬é˜ˆå€¼ä¸èƒ½å°äº5000å­—ç¬¦ã€‚", 3000); longTextThresholdInput.value = LONG_TEXT_THRESHOLD; return; }
            updateAutoDisableDiffInfoSpan();
            diffAlgorithmType = diffAlgorithmSelect.value;
            const newDebounceTime = parseInt(diffDebounceTimeInput.value, 10);
            if (newDebounceTime >= 1000) { diffDebounceTime = newDebounceTime; }
            else { showToast("å†…å®¹æ›´æ–°æ£€æµ‹å»¶è¿Ÿä¸èƒ½å°äº1000æ¯«ç§’ (å³1ç§’)", 3000); diffDebounceTimeInput.value = diffDebounceTime; return; }
            const newThresholdPercent = parseInt(diffMatchThresholdInput.value, 10);
            if (newThresholdPercent >= 50 && newThresholdPercent <= 100) { diffMatchThreshold = newThresholdPercent / 100; }
            else { showToast("åŸæ–‡ç›¸ä¼¼åº¦è¦æ±‚å¿…é¡»åœ¨50%åˆ°100%ä¹‹é—´", 3000); diffMatchThresholdInput.value = Math.round(diffMatchThreshold * 100); diffMatchThresholdRange.value = Math.round(diffMatchThreshold * 100); return; }
            saveDiffSettings();
            hideDiffConfigModal();
            showToast("æ™ºèƒ½è¯†åˆ«è®¾ç½®å·²ä¿å­˜ï¼");
            checkAndManageDiffForLongText();
            if (isDiffTrackingEnabled && activeSavedDocument.id) { handleContentChangeForAssociation(); }
        }

        function analyzeContentDifference(originalText, currentText, threshold, algorithm) {
            if (!jsdiffInstance) { return { isRetained: (originalText === currentText), rate: (originalText === currentText ? 1 : 0), diffs: [] }; }
            if (originalText === null || originalText === undefined) originalText = "";
            if (currentText === null || currentText === undefined) currentText = "";
            const countCharsRobust = (text) => text.length;
            const countWordsRobust = (text) => text.split(/\s+/).filter(Boolean).length;
            const countLinesRobust = (text) => (text === "" ? 0 : text.split('\n').length);
            let currentUnitCountFunc;
            switch (algorithm) {
                case 'words': currentUnitCountFunc = countWordsRobust; break;
                case 'lines': currentUnitCountFunc = countLinesRobust; break;
                default: currentUnitCountFunc = countCharsRobust; break;
            }
            if (originalText === "") {
                const currentLengthInUnits = currentUnitCountFunc(currentText);
                return { isRetained: (currentLengthInUnits === 0), rate: (currentLengthInUnits === 0 ? 1 : 0), diffs: (currentLengthInUnits > 0 ? [{ added: true, value: currentText, count: currentLengthInUnits }] : []) };
            }
            if (originalText === currentText) { return { isRetained: true, rate: 1, diffs: [{ value: originalText, count: currentUnitCountFunc(originalText) }] }; }
            let diffs;
            switch (algorithm) {
                case 'words': diffs = jsdiffInstance.diffWords(originalText, currentText); break;
                case 'lines': diffs = jsdiffInstance.diffLines(originalText, currentText, { newlineIsToken: true }); break;
                default: diffs = jsdiffInstance.diffChars(originalText, currentText); break;
            }
            const originalLengthInUnits = currentUnitCountFunc(originalText);
            let commonCountInUnits = 0;
            diffs.forEach(part => { if (!part.added && !part.removed && part.value) { commonCountInUnits += currentUnitCountFunc(part.value); } });
            let retentionRate = 0;
            if (originalLengthInUnits > 0) { retentionRate = commonCountInUnits / originalLengthInUnits; }
            else if (commonCountInUnits === 0) { retentionRate = 1; }
            const finalRate = Math.min(retentionRate, 1.0);
            return { isRetained: finalRate >= threshold, rate: finalRate, diffs: diffs };
        }

        function handleContentChangeForAssociation() {
            if (!activeSavedDocument.id || activeSavedDocument.originalContent === null) {
                currentDiffAnalysisResult = { isRetained: false, rate: 0, diffs: [] };
                updateActiveDocIndicators(); return;
            }
            clearTimeout(diffDebounceTimeout);
            diffDebounceTimeout = setTimeout(() => {
                if (!isDiffTrackingEnabled) { currentDiffAnalysisResult = { isRetained: false, rate: 0, diffs: [] }; updateActiveDocIndicators(); return; }
                const currentContent = editor.value;
                if (currentContent.length > LONG_TEXT_THRESHOLD && (!autoDisableDiffForLongTextToggle.checked || wasDiffTrackingEnabledBeforeLongText === null)) {
                    showToast("æ­£åœ¨è¿›è¡Œé•¿æ–‡æœ¬å…³è”åˆ†æï¼Œè¯·ç¨å€™...", 2000);
                }
                currentDiffAnalysisResult = analyzeContentDifference(activeSavedDocument.originalContent, currentContent, diffMatchThreshold, diffAlgorithmType);
                updateActiveDocIndicators();
            }, diffDebounceTime);
        }

        function calculateDiffSummary(diffs, algorithm) {
            if (!diffs || diffs.length === 0) return "";
            let added = 0; let removed = 0; let unit = "å­—";
            const countCharsRobust = (text) => text.length;
            const countWordsRobust = (text) => text.split(/\s+/).filter(Boolean).length;
            const countLinesRobust = (text) => (text === "" ? 0 : text.split('\n').length);
            let currentUnitCountFunc;
            if (algorithm === 'lines') {
                unit = "è¡Œ"; currentUnitCountFunc = countLinesRobust;
                diffs.forEach(part => {
                    if (part.added) added += (part.count || currentUnitCountFunc(part.value));
                    else if (part.removed) removed += (part.count || currentUnitCountFunc(part.value));
                });
            } else {
                if (algorithm === 'words') { unit = "è¯"; currentUnitCountFunc = countWordsRobust; }
                else { unit = "å­—"; currentUnitCountFunc = countCharsRobust; }
                diffs.forEach(part => {
                    if (part.added) added += currentUnitCountFunc(part.value);
                    else if (part.removed) removed += currentUnitCountFunc(part.value);
                });
            }
            let summaryText = "";
            if (added > 0) summaryText += `+${added}${unit} `;
            if (removed > 0) summaryText += `-${removed}${unit}`;
            return summaryText.trim();
        }


        function setActiveSavedDocumentState(id, name, content, isFromImport = false) {
            activeSavedDocument.id = id; activeSavedDocument.name = name; activeSavedDocument.originalContent = content; activeSavedDocument.isImported = isFromImport;
            currentDiffAnalysisResult = { isRetained: true, rate: 1.0, diffs: [] };
            updateActiveDocIndicators(); updateLoadSampleOrRevertButtonState(); checkAndManageDiffForLongText();
            console.log(`Active document set: ID ${id}, Name "${name}", Imported: ${isFromImport}`);
        }


        function clearActiveSavedDocumentState(isDestructiveLoad = false) {
            if (activeSavedDocument.id !== null) { console.log(`Active document cleared. Was: ID ${activeSavedDocument.id}, Name "${activeSavedDocument.name}"`); }
            activeSavedDocument.id = null; activeSavedDocument.name = null; activeSavedDocument.originalContent = null; activeSavedDocument.isImported = false;
            currentDiffAnalysisResult = { isRetained: false, rate: 0, diffs: [] };
            if (isDestructiveLoad) { updateActiveDocIndicators(); updateLoadSampleOrRevertButtonState(); checkAndManageDiffForLongText(); updateWordCount(); }
        }

        function updateActiveDocIndicators() {
            const { isRetained, rate, diffs } = currentDiffAnalysisResult;
            if (activeSavedDocument.id && activeSavedDocument.name) {
                if (activeDocInfoContainer) activeDocInfoContainer.style.display = 'inline-flex';
                activeDocNameEl.textContent = escapeHtml(truncateText(activeSavedDocument.name, 20));
                activeDocNameEl.title = `å½“å‰ç¼–è¾‘åŸºäºæ–‡æ¡£: ${escapeHtml(activeSavedDocument.name)}`;
                let statusText = ""; let statusTitle = "";
                const docTypePrefix = activeSavedDocument.isImported ? "å¯¼å…¥æ–‡ä»¶" : "æ–‡æ¡£";
                if (rate === 1.0 && normalizeTextForComparison(editor.value) === normalizeTextForComparison(activeSavedDocument.originalContent)) {
                    statusText = "(åŸå§‹å†…å®¹)"; statusTitle = `å†…å®¹ä¸${docTypePrefix} "${escapeHtml(activeSavedDocument.name)}" çš„åŸå§‹ç‰ˆæœ¬ä¸€è‡´`;
                    trackingStrengthIndicator.style.display = 'none'; changeSummaryIndicator.style.display = 'none';
                    if (isDiffTrackingEnabled && jsdiffInstance) {
                        trackingStrengthIndicator.textContent = `100%`; trackingStrengthIndicator.className = 'strong';
                        trackingStrengthIndicator.style.display = 'inline-block';
                    }
                }
                else if (isDiffTrackingEnabled) {
                    if (isRetained) { statusText = "(è¯†åˆ«ä¸ºä¿®æ”¹ç‰ˆ)"; statusTitle = `å†…å®¹å·²ä¿®æ”¹ï¼Œç³»ç»Ÿä»è®¤ä¸ºä¸${docTypePrefix} "${escapeHtml(activeSavedDocument.name)}" ç›¸å…³è” (ç›¸ä¼¼åº¦: ${Math.round(rate * 100)}%)`; }
                    else { statusText = "(å…³è”åº¦ä½)"; statusTitle = `å†…å®¹ä¸${docTypePrefix} "${escapeHtml(activeSavedDocument.name)}" å·®å¼‚è¾ƒå¤§ (ç›¸ä¼¼åº¦: ${Math.round(rate * 100)}%)ï¼Œç³»ç»Ÿä¸å†è®¤ä¸ºå®ƒä»¬å¼ºç›¸å…³`; }
                    trackingStrengthIndicator.textContent = `${Math.round(rate * 100)}%`;
                    trackingStrengthIndicator.className = isRetained ? 'strong' : 'weak';
                    trackingStrengthIndicator.style.display = 'inline-block';
                    changeSummaryIndicator.textContent = calculateDiffSummary(diffs, diffAlgorithmType);
                    changeSummaryIndicator.style.display = changeSummaryIndicator.textContent ? 'inline-block' : 'none';
                } else {
                    if (activeSavedDocument.originalContent !== null && normalizeTextForComparison(editor.value) !== normalizeTextForComparison(activeSavedDocument.originalContent)) {
                        statusText = "(å·²ä¿®æ”¹)"; statusTitle = `å†…å®¹å·²ä¿®æ”¹ (æ™ºèƒ½è¯†åˆ«å·²å…³é—­${wasDiffTrackingEnabledBeforeLongText ? ' - å› é•¿æ–‡æœ¬ä¸´æ—¶å…³é—­' : ''})`;
                    } else if (activeSavedDocument.originalContent !== null && normalizeTextForComparison(editor.value) === normalizeTextForComparison(activeSavedDocument.originalContent)) {
                        statusText = "(åŸå§‹å†…å®¹)"; statusTitle = `å†…å®¹ä¸${docTypePrefix} "${escapeHtml(activeSavedDocument.name)}" çš„åŸå§‹ç‰ˆæœ¬ä¸€è‡´ (æ™ºèƒ½è¯†åˆ«å·²å…³é—­)`;
                    } else if (wasDiffTrackingEnabledBeforeLongText) { statusText = ""; statusTitle = `æ™ºèƒ½è¯†åˆ«å·²å› é•¿æ–‡æœ¬ä¸´æ—¶å…³é—­`; }
                    trackingStrengthIndicator.style.display = 'none'; changeSummaryIndicator.style.display = 'none';
                }
                activeDocStatusEl.textContent = statusText; activeDocStatusEl.title = statusTitle;
                if (dissociateActiveDocButton) { dissociateActiveDocButton.style.display = 'inline-block'; }
            } else {
                if (activeDocInfoContainer) activeDocInfoContainer.style.display = 'none';
                activeDocNameEl.textContent = ''; activeDocNameEl.title = '';
                activeDocStatusEl.textContent = ''; activeDocStatusEl.title = '';
                if (dissociateActiveDocButton) dissociateActiveDocButton.style.display = 'none';
                trackingStrengthIndicator.style.display = 'none'; changeSummaryIndicator.style.display = 'none';
            }
        }

        function manuallyDissociateActiveDocument() {
            if (activeSavedDocument.id) {
                if (confirm(`ç¡®å®šè¦è§£é™¤å½“å‰ç¼–è¾‘å™¨å†…å®¹ä¸æ–‡æ¡£ "${activeSavedDocument.name}" çš„å…³è”å—ï¼Ÿä¹‹åç¼–è¾‘å™¨å†…å®¹å°†è¢«è§†ä¸ºä¸€ä¸ªå…¨æ–°çš„æ–‡æ¡£ã€‚`)) {
                    const oldDocName = activeSavedDocument.name;
                    const editorContentBeforeDissociate = editor.value;
                    console.log(`Dissociating from: ID ${activeSavedDocument.id}, Name "${oldDocName}"`);
                    activeSavedDocument.id = null; activeSavedDocument.name = null; activeSavedDocument.originalContent = null;
                    activeSavedDocument.isImported = false;
                    currentDiffAnalysisResult = { isRetained: false, rate: 0, diffs: [] };
                    editor.value = editorContentBeforeDissociate;
                    updateActiveDocIndicators();
                    updateLoadSampleOrRevertButtonState();
                    showToast(`å·²è§£é™¤ä¸ "${oldDocName}" çš„å…³è”ã€‚ç¼–è¾‘å™¨å†…å®¹ç°åœ¨æ˜¯æ–°æ–‡æ¡£ã€‚`);
                    lastSavedHistoryContent = null;
                    triggerHistorySave();
                    updateWordCount();
                }
            } else { showToast("å½“å‰æ²¡æœ‰æ´»åŠ¨çš„å…³è”æ–‡æ¡£ã€‚"); }
        }

        function normalizeTextForComparison(text) {
            if (text === null || text === undefined) return "";
            return text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        }

        function showLoadModal() { populateModal(false); }
        function showSaveModal() { populateModal(true); }
        function hideLoadModal() {
            loadModal.style.display = 'none';
            loadModal.classList.remove('show-flex');
        }

        async function populateModal(isSavingMode = false) {
            modalTitle.textContent = isSavingMode ? "ä¿å­˜æˆ–æ›´æ–° Markdown" : "åŠ è½½å·²ä¿å­˜çš„ Markdown";
            saveNewButton.style.display = isSavingMode ? 'inline-flex' : 'none';
            saveAsVersionButton.style.display = 'none';
            searchInput.value = '';
            try {
                const items = await loadAllMarkdown();
                savedItemList.innerHTML = '';
                const noItemsLi = '<li class="no-items">æ²¡æœ‰æ‰¾åˆ°å·²ä¿å­˜çš„æ–‡æ¡£ã€‚</li>';
                if (isSavingMode) {
                    const { isRetained, rate } = currentDiffAnalysisResult;
                    if (isDiffTrackingEnabled && activeSavedDocument.id && activeSavedDocument.name && editor.value !== activeSavedDocument.originalContent && isRetained && rate < SIGNIFICANT_MODIFICATION_THRESHOLD) {
                        saveAsVersionButton.textContent = `å¦å­˜ä¸º "${truncateText(activeSavedDocument.name, 15)} v.${getTimestampForFilename(true)}"`;
                        saveAsVersionButton.style.display = 'inline-flex';
                    }
                }
                if (items && items.length > 0) {
                    let activeItemElement = null;
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'saved-item';
                        li.dataset.id = item.id; li.dataset.name = item.name;
                        li.innerHTML = `
                            <div class="item-info">
                                <span class="item-name" title="${escapeHtml(item.name)}">${escapeHtml(item.name)}</span>
                                <span class="item-timestamp">ä¿å­˜äº: ${formatTimestamp(item.timestamp)}</span>
                            </div>
                            <div class="item-actions">
                                ${isSavingMode ? `<button class="small" onclick="handleUpdateItem(event, ${item.id})" title="ä½¿ç”¨å½“å‰ç¼–è¾‘å™¨å†…å®¹è¦†ç›–æ­¤é¡¹">æ›´æ–°</button>` : ''}
                                <button class="small" onclick="handleLoadItem(${item.id})" title="åŠ è½½æ­¤é¡¹åˆ°ç¼–è¾‘å™¨">åŠ è½½</button>
                                <button class="small danger" onclick="handleDeleteItem(event, ${item.id}, 'saved')" title="åˆ é™¤æ­¤é¡¹">åˆ é™¤</button>
                            </div>`;
                        savedItemList.appendChild(li);
                        if (isSavingMode && isDiffTrackingEnabled && currentDiffAnalysisResult.isRetained && activeSavedDocument.id && typeof activeSavedDocument.id === 'number' && activeSavedDocument.id === item.id) {
                            li.classList.add('highlighted-active-doc');
                            activeItemElement = li;
                        }
                    });
                    if (activeItemElement) {
                        loadModal.style.display = 'flex';
                        loadModal.classList.add('show-flex');
                        requestAnimationFrame(() => { activeItemElement.scrollIntoView({ behavior: 'auto', block: 'center', inline: 'nearest' }); });
                    } else { loadModal.style.display = 'flex'; loadModal.classList.add('show-flex'); }
                } else { savedItemList.innerHTML = noItemsLi; loadModal.style.display = 'flex'; loadModal.classList.add('show-flex'); }
                filterSavedItems();
            } catch (error) { showToast(`åŠ è½½åˆ—è¡¨å¤±è´¥: ${error}`); savedItemList.innerHTML = '<li class="no-items" style="color:red;">åŠ è½½åˆ—è¡¨æ—¶å‡ºé”™ã€‚</li>'; loadModal.style.display = 'flex'; loadModal.classList.add('show-flex'); }
        }
        function filterSavedItems() {
            const filter = searchInput.value.toLowerCase();
            const items = savedItemList.querySelectorAll('li.saved-item');
            let visibleCount = 0;
            const noItemsMessage = savedItemList.querySelector('.no-items') || document.createElement('li');
            noItemsMessage.className = 'no-items';
            noItemsMessage.textContent = filter ? 'æ²¡æœ‰åŒ¹é…çš„æ–‡æ¡£ã€‚' : 'æ²¡æœ‰æ‰¾åˆ°å·²ä¿å­˜çš„æ–‡æ¡£ã€‚';
            items.forEach(item => {
                const name = item.dataset.name ? item.dataset.name.toLowerCase() : '';
                if (name.includes(filter)) { item.style.display = 'flex'; visibleCount++; }
                else { item.style.display = 'none'; }
            });
            if (visibleCount === 0 && items.length > 0) { if (!savedItemList.contains(noItemsMessage)) savedItemList.appendChild(noItemsMessage); noItemsMessage.style.display = 'block'; }
            else if (visibleCount > 0) { if (savedItemList.contains(noItemsMessage)) noItemsMessage.style.display = 'none'; }
            else if (items.length === 0) { if (!savedItemList.contains(noItemsMessage)) { savedItemList.innerHTML = ''; savedItemList.appendChild(noItemsMessage); } noItemsMessage.style.display = 'block'; }
        }
        function showHistoryModal() { populateHistoryModal(); }
        function hideHistoryModal() {
            historyModal.style.display = 'none';
            historyModal.classList.remove('show-flex');
        }
        async function populateHistoryModal() {
            try {
                const items = await loadAllHistory();
                historyItemList.innerHTML = '';
                const noItemsLi = '<li class="no-items">æ²¡æœ‰ç¼–è¾‘å†å²è®°å½•ã€‚</li>';
                if (items && items.length > 0) {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'history-item';
                        li.dataset.id = item.id;
                        const previewText = item.content.substring(0, 60).replace(/\n/g, ' ') + (item.content.length > 60 ? '...' : '');
                        li.innerHTML = `
                            <div class="item-info">
                                <span class="item-timestamp">è®°å½•äº: ${formatTimestamp(item.timestamp)}</span>
                                <span class="item-content-preview" title="${escapeHtml(item.content.substring(0, 200))}">${escapeHtml(previewText)}</span>
                            </div>
                            <div class="item-actions">
                                <button class="small primary" onclick="handleRestoreHistory(${item.id})" title="æ¢å¤æ­¤ç‰ˆæœ¬åˆ°ç¼–è¾‘å™¨">æ¢å¤</button>
                                <button class="small danger" onclick="handleDeleteItem(event, ${item.id}, 'history')" title="åˆ é™¤æ­¤å†å²è®°å½•">åˆ é™¤</button>
                            </div>`;
                        historyItemList.appendChild(li);
                    });
                } else { historyItemList.innerHTML = noItemsLi; }
                historyModal.style.display = 'flex';
                historyModal.classList.add('show-flex');
            } catch (error) { showToast(`åŠ è½½å†å²åˆ—è¡¨å¤±è´¥: ${error}`); historyItemList.innerHTML = '<li class="no-items" style="color:red;">åŠ è½½å†å²åˆ—è¡¨æ—¶å‡ºé”™ã€‚</li>'; historyModal.style.display = 'flex'; historyModal.classList.add('show-flex'); }
        }

        async function handleSaveNew() {
            const content = editor.value;
            if (!content.trim()) { showToast("ç¼–è¾‘å™¨å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜ã€‚"); return; }
            let defaultNameSuggestion = `Markdown ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
            if (activeSavedDocument.id && activeSavedDocument.isImported && activeSavedDocument.name) { defaultNameSuggestion = activeSavedDocument.name; }
            const name = prompt("è¯·è¾“å…¥æ–°æ–‡æ¡£çš„åç§°:", defaultNameSuggestion);
            if (name === null || name.trim() === "") { showToast("å·²å–æ¶ˆä¿å­˜æˆ–åç§°æ— æ•ˆã€‚"); return; }
            try {
                const newId = await saveMarkdown(name.trim(), content);
                showToast(`"${name.trim()}" å·²æˆåŠŸä¿å­˜ï¼`);
                if (newId) setActiveSavedDocumentState(newId, name.trim(), content, false);
                else clearActiveSavedDocumentState();
                hideLoadModal();
            }
            catch (error) { console.error("Save new failed:", error); }
        }

        async function handleSaveAsVersion() {
            const content = editor.value;
            if (!content.trim()) { showToast("ç¼–è¾‘å™¨å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜ã€‚"); return; }
            if (!activeSavedDocument.id || !activeSavedDocument.name) { showToast("æ²¡æœ‰å¯ä½œä¸ºç‰ˆæœ¬çš„åŸå§‹æ–‡æ¡£ã€‚è¯·å…ˆåŠ è½½æˆ–å¯¼å…¥ä¸€ä¸ªæ–‡æ¡£ã€‚"); return; }
            const versionedName = `${activeSavedDocument.name} v.${getTimestampForFilename(true)}`;
            const name = prompt("è¯·è¾“å…¥æ–°ç‰ˆæœ¬æ–‡æ¡£çš„åç§°:", versionedName);
            if (name === null || name.trim() === "") { showToast("å·²å–æ¶ˆä¿å­˜æˆ–åç§°æ— æ•ˆã€‚"); return; }
            try {
                const newId = await saveMarkdown(name.trim(), content);
                showToast(`ç‰ˆæœ¬ "${name.trim()}" å·²æˆåŠŸå¦å­˜ï¼`);
                if (newId) setActiveSavedDocumentState(newId, name.trim(), content, false);
                hideLoadModal();
            } catch (error) { console.error("Save as version failed:", error); }
        }


        async function handleUpdateItem(event, id) {
            event.stopPropagation();
            const content = editor.value;
            if (!content.trim()) { showToast("ç¼–è¾‘å™¨å†…å®¹ä¸ºç©ºï¼Œæ— æ³•æ›´æ–°ã€‚"); return; }
            try {
                const itemToUpdate = await loadMarkdownById(id);
                if (!itemToUpdate) { showToast("æ‰¾ä¸åˆ°è¦æ›´æ–°çš„é¡¹ç›®ã€‚"); populateModal(true); return; }
                if (confirm(`ç¡®å®šè¦ç”¨å½“å‰ç¼–è¾‘å™¨å†…å®¹è¦†ç›– "${itemToUpdate.name}" å—ï¼Ÿ`)) {
                    const newName = prompt("è¯·è¾“å…¥æ›´æ–°åçš„åç§°ï¼ˆç•™ç©ºåˆ™ä¿ç•™åŸåï¼‰:", itemToUpdate.name);
                    if (newName === null) { showToast("æ›´æ–°å·²å–æ¶ˆã€‚"); return; }
                    const finalName = (newName.trim() === "") ? itemToUpdate.name : newName.trim();
                    await updateMarkdown(id, finalName, content);
                    showToast(`"${finalName}" å·²æˆåŠŸæ›´æ–°ï¼`);
                    setActiveSavedDocumentState(id, finalName, content, false);
                    hideLoadModal();
                } else { showToast("æ›´æ–°å·²å–æ¶ˆã€‚"); }
            } catch (error) { console.error("Update failed:", error); }
        }
        async function handleLoadItem(id) {
            try {
                const item = await loadMarkdownById(id);
                if (item) {
                    editor.value = item.content;
                    requestPreviewUpdate();
                    setActiveSavedDocumentState(item.id, item.name, item.content, false);
                    hideLoadModal(); editor.scrollTop = 0;
                    showToast(`å·²åŠ è½½: ${item.name}`);
                    triggerHistorySave();
                    updateLoadSampleOrRevertButtonState();
                    updateWordCount();
                } else { showToast("æ— æ³•æ‰¾åˆ°è¯¥é¡¹ç›®ã€‚"); }
            } catch (error) { console.error("Load item failed:", error); }
        }
        async function handleRestoreHistory(id) {
            try {
                const item = await loadHistoryById(id);
                if (item) {
                    editor.value = item.content;
                    requestPreviewUpdate();
                    hideHistoryModal(); editor.scrollTop = 0;
                    showToast(`å·²ä» ${formatTimestamp(item.timestamp)} æ¢å¤`);
                    lastSavedHistoryContent = item.content;
                    clearActiveSavedDocumentState(true);
                    updateLoadSampleOrRevertButtonState();
                    updateWordCount();
                } else { showToast("æ— æ³•æ‰¾åˆ°è¯¥å†å²è®°å½•ã€‚"); }
            } catch (error) { console.error("Restore history failed:", error); }
        }
        async function handleDeleteItem(event, id, type) {
            event.stopPropagation();
            const listElement = (type === 'saved') ? savedItemList : historyItemList;
            const itemElement = listElement.querySelector(`li[data-id='${id}']`);
            const itemName = (type === 'saved' && itemElement) ? itemElement.dataset.name : `æ­¤${type === 'saved' ? 'æ–‡æ¡£' : 'å†å²è®°å½•'}`;
            const deleteFunction = (type === 'saved') ? deleteMarkdownById : deleteHistoryById;
            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${itemName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                try {
                    const success = await deleteFunction(id);
                    if (success) {
                        if (itemElement) {
                            itemElement.style.transition = 'opacity 0.3s ease-out, height 0.3s ease-out, margin 0.3s ease-out, padding 0.3s ease-out, border 0.3s ease-out';
                            itemElement.style.opacity = '0'; itemElement.style.height = '0'; itemElement.style.margin = '0'; itemElement.style.padding = '0'; itemElement.style.border = 'none';
                            setTimeout(() => {
                                if (itemElement.parentNode) itemElement.remove();
                                if (type === 'saved') {
                                    filterSavedItems();
                                    if (activeSavedDocument.id === id) { clearActiveSavedDocumentState(true); }
                                }
                                else { if (historyItemList.querySelectorAll('.history-item').length === 0) { historyItemList.innerHTML = '<li class="no-items">æ²¡æœ‰ç¼–è¾‘å†å²è®°å½•ã€‚</li>'; } }
                            }, 300);
                        }
                        showToast(`"${itemName}" å·²åˆ é™¤ã€‚`);
                    } else { showToast(`åˆ é™¤ "${itemName}" å¤±è´¥ã€‚`); }
                } catch (error) { console.error(`Delete ${type} failed:`, error); }
            }
        }

        window.onclick = function (event) {
            if (event.target == loadModal) hideLoadModal();
            if (event.target == historyModal) hideHistoryModal();
            if (event.target == diffConfigModal) hideDiffConfigModal();
        }
        window.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                if (['block', 'flex'].includes(loadModal.style.display)) hideLoadModal();
                if (['block', 'flex'].includes(historyModal.style.display)) hideHistoryModal();
                if (['block', 'flex'].includes(diffConfigModal.style.display)) hideDiffConfigModal();
                if (dragDropOverlay.style.display === 'flex') {
                    dragDropOverlay.style.display = 'none';
                    document.body.classList.remove('drag-over');
                }
            }
        });


        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        function formatTimestamp(date) {
            if (!(date instanceof Date)) date = new Date(date);
            if (isNaN(date)) return "Invalid Date";
            try { return date.toLocaleString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
            catch (e) { console.error("Error formatting date:", e); return "Error Date"; }
        }
        function sanitizeFilenameComponent(name) {
            if (!name || typeof name !== 'string') return '';
            return name.trim().replace(/[<>:"/\\|?*\s]+/g, '-').replace(/[\x00-\x1f\x7f]/g, '').substring(0, 100);
        }
        function getTimestampForFilename(short = false) {
            const now = new Date();
            if (short) { return `${now.getFullYear().toString().slice(-2)}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`; }
            return `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
        }
        function truncateText(text, maxLength) {
            if (typeof text !== 'string') return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function generateBaseFilename() {
            let baseName = '';
            if (isDiffTrackingEnabled && currentDiffAnalysisResult.isRetained && activeSavedDocument.id && activeSavedDocument.name) { baseName = sanitizeFilenameComponent(activeSavedDocument.name); }
            else if (!isDiffTrackingEnabled && activeSavedDocument.id && activeSavedDocument.isImported && activeSavedDocument.name) { baseName = sanitizeFilenameComponent(activeSavedDocument.name); }
            if (!baseName) {
                const content = editor.value.trim();
                const h1Match = content.match(/^#\s+(.*)/m);
                if (h1Match && h1Match[1]) { baseName = sanitizeFilenameComponent(h1Match[1]); }
                else { const firstLine = content.split('\n')[0]; if (firstLine) { baseName = sanitizeFilenameComponent(firstLine.substring(0, 50)); } }
            }
            if (!baseName || baseName.length === 0) baseName = 'markdown-export';
            return `${baseName}-${getTimestampForFilename()}`;
        }


        function syncScroll(source, target) {
            if (isSyncing) return; isSyncing = true;
            const ratio = source.scrollTop / (source.scrollHeight - source.clientHeight || 1);
            target.scrollTop = ratio * (target.scrollHeight - target.clientHeight);
            requestAnimationFrame(() => { isSyncing = false; });
        }
        editor.addEventListener('scroll', () => syncScroll(editor, preview));
        preview.addEventListener('scroll', () => syncScroll(preview, editor));

        let dragCounter = 0;
        function setupDragDropListeners() {
            const body = document.body;
            body.addEventListener('dragenter', (event) => {
                event.preventDefault(); event.stopPropagation(); dragCounter++;
                if (dragCounter === 1 && dragDropOverlay) {
                    dragDropOverlay.style.display = 'flex'; dragDropOverlay.classList.add('visible');
                    body.classList.add('drag-over');
                }
            }, false);
            body.addEventListener('dragover', (event) => {
                event.preventDefault(); event.stopPropagation(); event.dataTransfer.dropEffect = 'copy';
            }, false);
            body.addEventListener('dragleave', (event) => {
                event.preventDefault(); event.stopPropagation(); dragCounter--;
                if (dragCounter === 0 && dragDropOverlay) {
                    dragDropOverlay.style.display = 'none'; dragDropOverlay.classList.remove('visible');
                    body.classList.remove('drag-over');
                }
            }, false);
            body.addEventListener('drop', (event) => {
                event.preventDefault(); event.stopPropagation(); dragCounter = 0;
                if (dragDropOverlay) { dragDropOverlay.style.display = 'none'; dragDropOverlay.classList.remove('visible'); body.classList.remove('drag-over'); }
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const allowedTypes = ['text/markdown', 'text/plain', ''];
                    const allowedExtensions = ['.md', '.txt'];
                    const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                    console.log(`Dropped file: ${file.name}, type: ${file.type}, ext: ${fileExtension}`);
                    if (allowedExtensions.includes(fileExtension) || allowedTypes.includes(file.type)) {
                        const reader = new FileReader();
                        reader.onload = (e_reader) => { handleImportedFileContent(e_reader.target.result, file.name, 'drag-drop'); };
                        reader.onerror = (e_reader) => { console.error("File reading error (drag-drop):", e_reader.target.error); showToast("æ–‡ä»¶è¯»å–å¤±è´¥ã€‚"); };
                        reader.readAsText(file);
                    } else { showToast(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name} (ä»…æ”¯æŒ .md, .txt)`, 4000); console.warn(`Skipped non-text file (drag-drop): ${file.name}, type: ${file.type}`); }
                }
            }, false);
        }

        // --- Pane Collapse Functions ---
        function updateLayoutAndButtonStates() {
            if (editorPaneCollapsed) {
                pageContainer.style.gridTemplateColumns = 'var(--grid-columns-editor-collapsed)';
                editorPane.classList.add('pane-collapsed');
            } else {
                editorPane.classList.remove('pane-collapsed');
            }

            if (previewPaneCollapsed) {
                pageContainer.style.gridTemplateColumns = 'var(--grid-columns-preview-collapsed)';
                previewPane.classList.add('pane-collapsed');
            } else {
                previewPane.classList.remove('pane-collapsed');
            }

            if (!editorPaneCollapsed && !previewPaneCollapsed) {
                pageContainer.style.gridTemplateColumns = 'var(--grid-columns-normal)';
            }

            toggleEditorBtn.innerHTML = editorPaneCollapsed ? ICONS.chevronRight : ICONS.chevronLeft;
            toggleEditorBtn.title = editorPaneCollapsed ? 'å±•å¼€ç¼–è¾‘åŒº' : 'æ”¶èµ·ç¼–è¾‘åŒº';
            toggleEditorBtn.disabled = previewPaneCollapsed;

            togglePreviewBtn.innerHTML = previewPaneCollapsed ? ICONS.chevronLeft : ICONS.chevronRight;
            togglePreviewBtn.title = previewPaneCollapsed ? 'å±•å¼€é¢„è§ˆåŒº' : 'æ”¶èµ·é¢„è§ˆåŒº';
            togglePreviewBtn.disabled = editorPaneCollapsed;
        }

        function toggleEditorPane() {
            if (editorPaneCollapsed) { // Try to expand editor
                editorPaneCollapsed = false;
            } else { // Try to collapse editor
                if (previewPaneCollapsed) { // If preview is already collapsed, expand it first
                    previewPaneCollapsed = false;
                }
                editorPaneCollapsed = true;
            }
            updateLayoutAndButtonStates();
        }

        function togglePreviewPane() {
            if (previewPaneCollapsed) { // Try to expand preview
                previewPaneCollapsed = false;
            } else { // Try to collapse preview
                if (editorPaneCollapsed) { // If editor is already collapsed, expand it first
                    editorPaneCollapsed = false;
                }
                previewPaneCollapsed = true;
            }
            updateLayoutAndButtonStates();
        }


        editor.addEventListener('input', () => {
            requestPreviewUpdate(); scheduleHistorySave(); checkAndManageDiffForLongText();
            handleContentChangeForAssociation(); updateLoadSampleOrRevertButtonState(); updateWordCount();
        });
        editor.addEventListener('paste', (event) => {
            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            if (pastedText.length > LONG_TEXT_THRESHOLD / 2) {
                if (isDiffTrackingEnabled && !autoDisableDiffForLongTextToggle.checked && pastedText.length > LONG_TEXT_THRESHOLD) { showToast("æ­£åœ¨å¤„ç†å¤§é‡ç²˜è´´å†…å®¹ï¼Œæ™ºèƒ½è¯†åˆ«åˆ†æå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´...", 3000); }
                else if (pastedText.length > LONG_TEXT_THRESHOLD) { showToast("æ­£åœ¨å¤„ç†å¤§é‡ç²˜è´´å†…å®¹...", 2000); }
            }
            setTimeout(() => { requestPreviewUpdate(); triggerHistorySave(); checkAndManageDiffForLongText(); handleContentChangeForAssociation(); updateLoadSampleOrRevertButtonState(); updateWordCount(); }, 0);
        });
        editor.addEventListener('blur', () => { clearTimeout(historySaveTimeout); saveCurrentStateToHistory(); });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMarkdownIt();
            handleLoadSampleOrRevert();
            updateLoadSampleOrRevertButtonState();

            initDB().then(() => {
                console.log("DB Initialized.");
                pruneHistory();
                setupDragDropListeners();

                if (typeof Diff === 'undefined') {
                    console.error("jsdiff library (Diff) not loaded!");
                    showToast("é”™è¯¯ï¼šæ™ºèƒ½è¯†åˆ«ç»„ä»¶æœªåŠ è½½ï¼Œå…³è”åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚", 5000);
                    isDiffTrackingEnabled = false; jsdiffInstance = null;
                } else { jsdiffInstance = Diff; console.log("jsdiff (Diff) instance ready."); }
                loadDiffSettings();
                const diffConfigButton = document.querySelector('button[onclick="showDiffConfigModal()"]');
                if (diffConfigButton && !jsdiffInstance) diffConfigButton.disabled = true;

                checkAndManageDiffForLongText();
                updateWordCount(); // Initial word count

                // Pane collapse setup
                toggleEditorBtn.addEventListener('click', toggleEditorPane);
                togglePreviewBtn.addEventListener('click', togglePreviewPane);
                updateLayoutAndButtonStates(); // Set initial button icons and states

                console.warn(
                    "\n %cğŸ—¿ MARKDOWN EDITOR (Markdown-it Edition) - å¼€å‘è€…å®ˆåˆ™ ğŸ¤%c\n\n" +
                    " %c1. æ‰€æœ‰æ–°åŠŸèƒ½éœ€é€šè¿‡ \"7å¤©å†·é™æœŸæµ‹è¯•\"%c ï¼ˆå¦‚æœ7å¤©åè¿˜è§‰å¾—éåŠ ä¸å¯ï¼Œå†è®®ï¼‰\n" +
                    " %c2. æ¯å¢ä¸€æŒ‰é’®ï¼Œéœ€è¦åˆ é™¤ä¸€ä¸ªæ—§æŒ‰é’®%c ï¼ˆè§„åˆ™1ä¾‹å¤–æ—¶æ­¤æ¡ä¹Ÿå¤±æ•ˆï¼‰\n" +
                    " %c3. å…‹åˆ¶æ˜¯ç¾å¾·%c â€”â€” ä¸ä¸ºæ»¡è¶³5%çš„è¾¹ç¼˜éœ€æ±‚ï¼Œæ·»åŠ 95%çš„å¤æ‚åº¦\n" +
                    "    %cã€Œç®€å•æ˜¯ç»ˆæçš„å¤æ‚ã€%c â€”â€” è¾¾èŠ¬å¥‡å¦‚æ˜¯è¯´ï¼ˆå¤§æ¦‚ï¼‰\n\n" +
                    " %câ€”â€” Self @ " + new Date('2025/05/20').toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }) + "%c\n" +
                    " %c[Markdown-it è¿ç§»å®Œæˆï¼Œæ–°æ’ä»¶å·²é›†æˆã€‚]%c ",
                    "color:#D32F2F;font-weight:bold;font-size:13px;font-family:Menlo,monospace;border-bottom:2px solid #FFCC80;", "",
                    "color:#1976D2;font-weight:600;", "color:#757575;",
                    "color:#1976D2;font-weight:600;", "color:#757575;",
                    "color:#1976D2;font-weight:600;", "color:#757575;",
                    "color:#43A047;font-style:italic;", "color:#757575;",
                    "color:#616161;letter-spacing:.5px;", "",
                    "color:#9E9E9E;font-size:0.9em;", ""
                );
            }).catch(err => console.error("Initial DB connection failed:", err));
        });

    </script>
</body>

</html>